<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å® ç‰©å–‚é£Ÿå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f9fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .navbar {
            background: #2563eb;
            color: #fff;
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
        }
        .navbar .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .navbar .logo::before {
            content: 'ğŸ’™';
            font-size: 22px;
            margin-right: 8px;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .navbar .device-id {
            font-size: 15px;
            opacity: 0.92;
        }
        .navbar .logout {
            color: #fff;
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            opacity: 0.85;
        }
        .navbar .logout:hover {
            text-decoration: underline;
            opacity: 1;
        }
        .main-container {
            max-width: 1200px;
            margin: 32px auto 0 auto;
            padding: 0 16px;
        }
        .status-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 220px;
            min-width: 200px;
            background: linear-gradient(120deg, #4ade80 0%, #22d3ee 100%);
            color: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(34,211,238,0.08);
            padding: 24px 18px 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .status-card.status-online { background: linear-gradient(120deg, #34d399 0%, #38bdf8 100%); }
        .status-card.status-weight { background: linear-gradient(120deg, #6366f1 0%, #818cf8 100%); }
        .status-card.status-plan { background: linear-gradient(120deg, #fbbf24 0%, #f59e42 100%); }
        .status-card.status-heartbeat { background: linear-gradient(120deg, #38bdf8 0%, #818cf8 100%); }
        .status-card.status-chart { background: linear-gradient(120deg, #60a5fa 0%, #818cf8 100%); }
        .status-card .card-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-card .card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .status-card .card-desc {
            font-size: 14px;
            opacity: 0.92;
        }
        .status-card .card-icon {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 28px;
            opacity: 0.18;
        }
        .actions-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }
        .actions-bar button, .actions-bar .export-btn {
            padding: 8px 22px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .actions-bar .export-btn {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
            color: #fff;
        }
        .actions-bar button:hover, .actions-bar .export-btn:hover {
            filter: brightness(1.08);
        }
        .card-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(60, 120, 200, 0.06);
            margin-bottom: 22px;
            padding: 18px 22px 18px 22px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e3e3e3;
            padding: 10px 6px;
            text-align: center;
        }
        th {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .msg {
            text-align: center;
            color: #388e3c;
            font-size: 16px;
            margin: 8px 0 0 0;
        }
        .error {
            color: #e53935;
        }
        @media (max-width: 900px) {
            .status-cards { flex-direction: column; gap: 14px; }
            .main-container { padding: 0 2vw; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            padding: 0;
            min-width: 400px;
            max-width: 90vw;
            position: relative;
            transform: scale(0.9);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            margin: 0;
            padding: 24px 32px 16px 32px;
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-content h3::before {
            content: 'âš ï¸';
            font-size: 24px;
        }
        /* æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹æ¡†æ ·å¼ */
        .add-plan-modal .modal-content h3::before {
            content: 'ğŸ“…';
        }
        /* æ‰‹åŠ¨å–‚é£Ÿå¼¹æ¡†æ ·å¼ */
        .manual-feed-modal .modal-content h3::before {
            content: 'ğŸ½ï¸';
        }
        .modal-content > div:not(.modal-actions):not(.msg) {
            padding: 24px 32px;
            font-size: 16px;
            color: #4b5563;
            line-height: 1.6;
            text-align: center;
        }
        .modal-content form {
            padding: 24px 32px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 16px;
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-top: 6px;
            transition: all 0.2s ease;
            background: #f9fafb;
        }
        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #2563eb;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .modal-content .add-plan-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .modal-content .add-plan-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        .modal-content .feed-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .modal-content .feed-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }
        .modal-actions {
            padding: 0 32px 24px 32px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .modal-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        .modal-actions button:first-child {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }
        .modal-actions button:first-child:hover {
            background: #e5e7eb;
            color: #374151;
        }
        .modal-actions button:last-child {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .modal-actions button:last-child:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        .modal-actions button:last-child:active {
            transform: translateY(0);
        }
        .msg {
            padding: 0 32px 16px 32px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }
        .msg.success {
            color: #059669;
        }
        .msg.error {
            color: #dc2626;
        }
        .msg.loading {
            color: #2563eb;
        }
        /* åˆ é™¤ç¡®è®¤å¼¹æ¡†ç‰¹æ®Šæ ·å¼ */
        .delete-modal .modal-content {
            border-top: 4px solid #ef4444;
        }
        .delete-modal .modal-content h3::before {
            content: 'ğŸ—‘ï¸';
        }
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .modal-content {
                min-width: 90vw;
                margin: 20px;
            }
            .modal-content h3 {
                padding: 20px 24px 12px 24px;
                font-size: 18px;
            }
            .modal-content > div:not(.modal-actions):not(.msg) {
                padding: 20px 24px;
                font-size: 15px;
            }
            .modal-actions {
                padding: 0 24px 20px 24px;
                flex-direction: column;
            }
            .modal-actions button {
                width: 100%;
                padding: 14px 24px;
            }
        }
        .week-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .week-btn {
            padding: 5px 16px;
            border: none;
            border-radius: 5px;
            background: #e3e8ef;
            color: #2563eb;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .week-btn.active, .week-btn:hover {
            background: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">å® ç‰©å–‚é£Ÿå™¨</div>
        <div class="nav-right">
            <a href="/admin/versions" class="logout">ç‰ˆæœ¬ç®¡ç†</a>
            <span class="device-id">ğŸ“‹ {{ device.device_id }}</span>
            <a href="/logout" class="logout">é€€å‡º</a>
        </div>
    </div>
    <div class="main-container">
        <div class="status-cards">
            <div class="status-card status-online">
                <div class="card-title">è®¾å¤‡çŠ¶æ€</div>
                <div class="card-value">{{ 'åœ¨çº¿' if device.is_online else 'ç¦»çº¿' }}</div>
                <div class="card-icon">ğŸ“¶</div>
            </div>
            <div class="status-card status-weight">
                <div class="card-title">ç²®æ¡¶é‡é‡</div>
                <div class="card-value">{{ device.grain_weight }}g</div>
                <div class="card-desc">æ›´æ–°æ—¶é—´: {{ last_grain_update_local.strftime('%H:%M:%S') if last_grain_update_local else '-' }}</div>
                <div style="position:absolute;top:18px;right:18px;display:flex;flex-direction:column;align-items:center;">
                    {% set percent = (device.grain_weight / 2000.0) if device.grain_weight < 2000 else 1.0 %}
                    <svg width="80" height="120" viewBox="0 0 80 120">
                        <defs>
                            <clipPath id="siloFillClip">
                                <rect x="20" y="22" width="40" height="60" rx="14"/>
                            </clipPath>
                        </defs>
                        <!-- ç²®ä»“å¤–è½®å»“ -->
                        <ellipse cx="40" cy="22" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <rect x="20" y="22" width="40" height="60" rx="14" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="82" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <!-- ç²®é£Ÿå¡«å…… -->
                        {% set fill_h = 60 * percent %}
                        <rect x="20" y="{{ 22+60-fill_h }}" width="40" height="{{ fill_h }}" fill="#7c4a03" clip-path="url(#siloFillClip)"/>
                        <!-- é«˜å…‰ -->
                        <ellipse cx="32" cy="52" rx="5" ry="22" fill="#fff" fill-opacity="0.10"/>
                        <!-- ç›–å­ -->
                        <ellipse cx="40" cy="14" rx="22" ry="6" fill="#e0e0e0"/>
                        <ellipse cx="40" cy="14" rx="16" ry="4" fill="#fff" fill-opacity="0.7"/>
                        <!-- å‡ºç²®å£ -->
                        <rect x="34" y="82" width="12" height="10" rx="4" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <ellipse cx="40" cy="92" rx="6" ry="3" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <!-- ç¢— -->
                        <rect x="16" y="92" width="48" height="20" rx="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="112" rx="24" ry="6" fill="#e0e0e0"/>
                        <!-- ç¢—å†…ç²®é£Ÿ -->
                        <ellipse cx="40" cy="104" rx="16" ry="5" fill="#7c4a03" fill-opacity="0.7"/>
                        <ellipse cx="40" cy="108" rx="12" ry="3" fill="#7c4a03" fill-opacity="0.5"/>
                    </svg>
                </div>
                <div style="width:100%;text-align:center;font-size:14px;font-weight:bold;color:#444;margin-top:8px;letter-spacing:1px;">æ€»å®¹é‡2000g</div>
            </div>
            <div class="status-card status-plan" style="position:relative;">
                <div class="card-title">å–‚é£Ÿè®¡åˆ’</div>
                <div class="card-value">{{ feeding_plans|length }}ä¸ª</div>
                <div class="card-desc">æ´»è·ƒè®¡åˆ’æ•°é‡</div>
                <div class="card-icon">âœ…</div>
            </div>
            <div class="status-card status-chart" style="background:linear-gradient(120deg,#60a5fa 0%,#818cf8 100%);color:#fff;">
                <div class="card-title">å–‚é£Ÿè®°å½•å›¾è¡¨</div>
                <div class="card-value" style="margin-bottom:12px;">å¯è§†åŒ–åˆ†æ</div>
                <button onclick="window.location.href='/feeding_chart'" style="padding:8px 18px;font-size:15px;border-radius:6px;background:#fff;color:#2563eb;border:none;cursor:pointer;font-weight:600;box-shadow:0 2px 8px #0002;">æŸ¥çœ‹å›¾è¡¨</button>
                <div class="card-desc" style="margin-top:10px;font-size:13px;opacity:0.92;">ç‚¹å‡»è¿›å…¥æŸ¥çœ‹24å°æ—¶å–‚é£Ÿé‡ç»Ÿè®¡</div>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="showPlanModal()" id="addPlanBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>â• æ·»åŠ å–‚é£Ÿè®¡åˆ’</button>
            <button onclick="showManualFeedModal()" id="manualFeedBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>ğŸ¤² æ‰‹åŠ¨å–‚é£Ÿ</button>
            <button id="syncBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>ğŸ”„ æ•°æ®åŒæ­¥</button>
            <a class="export-btn" href="/export_feeding_records/{{ device.device_id }}">â¬‡ï¸ å¯¼å‡ºæ•°æ®</a>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ“…</span>å–‚é£Ÿè®¡åˆ’</div>
            <table>
                <tr><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th><th>æ“ä½œ</th></tr>
                {% for key, total in merged_plans.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ parts[0] }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ '%02d'|format(parts[2]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>
                        <button onclick="deleteMergedPlan('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">åˆ é™¤</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5">æš‚æ— å–‚é£Ÿè®¡åˆ’</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ¤²</span>æ‰‹åŠ¨å–‚é£Ÿ</div>
            <table>
                <tr><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                {% for key, total in merged_manuals.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ '%02d'|format(parts[0]|int) }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>
                        {% if parts[2] == '1' %}
                            å·²æ‰§è¡Œ
                        {% else %}
                            å¾…æ‰§è¡Œ
                        {% endif %}
                    </td>
                    <td>
                        {% if parts[2] == '0' %}
                        <button onclick="deleteMergedManual('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">åˆ é™¤</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not merged_manuals %}
                <tr><td colspan="5">æš‚æ— æ‰‹åŠ¨å–‚é£Ÿè®°å½•</td></tr>
                {% endif %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ•’</span>æœ€è¿‘å–‚é£Ÿè®°å½•</div>
            <table>
                <tr><th>ç±»å‹</th><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>åˆ†é‡ (g)</th><th>å®é™… (g)</th><th>çŠ¶æ€</th><th>æ—¶é—´</th></tr>
                {% for record in recent_records %}
                <tr>
                    <td>è®¡åˆ’</td>
                    <td>{{ record.day_of_week }}</td>
                    <td>{{ '%02d'|format(record.hour) }}</td>
                    <td>{{ '%02d'|format(record.minute) }}</td>
                    <td>{{ record.feeding_amount }}</td>
                    <td>{{ record.actual_amount }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.created_at_local.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
                {% for m in recent_manual_feedings %}
                {% if m.is_executed %}
                <tr>
                    <td>æ‰‹åŠ¨</td>
                    <td>-</td>
                    <td>{{ '%02d'|format(m.hour) }}</td>
                    <td>{{ '%02d'|format(m.minute) }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>å·²æ‰§è¡Œ</td>
                    <td>{{ m.executed_at_local.strftime('%Y-%m-%d %H:%M:%S') if m.executed_at_local else '-' }}</td>
                </tr>
                {% endif %}
                {% endfor %}
                {% if not recent_records and not recent_manual_feedings %}
                <tr><td colspan="8">æš‚æ— å–‚é£Ÿè®°å½•</td></tr>
                {% elif recent_records|length == 0 and recent_manual_feedings|selectattr('is_executed')|list|length == 0 %}
                <tr><td colspan="8">æš‚æ— å–‚é£Ÿè®°å½•</td></tr>
                {% endif %}
            </table>
        </div>
        <div class="card-section" style="margin-bottom: 28px;">
            <div class="section-title"><span class="icon">ğŸ”„</span> è®¾å¤‡OTAå›ºä»¶å‡çº§</div>
            <form id="ota-form" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <input type="url" id="ota-url" name="ota_url" placeholder="è¯·è¾“å…¥å›ºä»¶ä¸‹è½½URLï¼Œå¦‚ http://your-server.com/firmware.bin" style="flex:1; min-width:220px; padding:10px 12px; border-radius:6px; border:1px solid #d1d5db; font-size:15px;" required>
                <button type="submit" style="padding:10px 28px; border:none; border-radius:6px; background:linear-gradient(90deg,#22d3ee 0%,#6366f1 100%); color:#fff; font-size:16px; font-weight:600; cursor:pointer; transition:background 0.2s;">ç«‹å³å‡çº§</button>
            </form>
            <div id="ota-msg" class="msg" style="display:none;"></div>
        </div>
        <!-- æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª— -->
        <div class="modal add-plan-modal" id="addPlanModal">
            <div class="modal-content">
                <h3>æ·»åŠ å–‚é£Ÿè®¡åˆ’</h3>
                <form id="addPlanForm" onsubmit="return false;">
                    <label>æ˜ŸæœŸ
                        <select name="day_of_week" required>
                            <option value="1">æ˜ŸæœŸä¸€</option>
                            <option value="2">æ˜ŸæœŸäºŒ</option>
                            <option value="3">æ˜ŸæœŸä¸‰</option>
                            <option value="4">æ˜ŸæœŸå››</option>
                            <option value="5">æ˜ŸæœŸäº”</option>
                            <option value="6">æ˜ŸæœŸå…­</option>
                            <option value="7">æ˜ŸæœŸæ—¥</option>
                        </select>
                    </label>
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideAddPlanModal()">å–æ¶ˆ</button>
                        <button type="submit" class="add-plan-btn">æ·»åŠ </button>
                    </div>
                </form>
                <div id="addPlanMsg" class="msg"></div>
            </div>
        </div>
        <!-- æ‰‹åŠ¨å–‚é£Ÿå¼¹çª— -->
        <div class="modal manual-feed-modal" id="manualFeedModal">
            <div class="modal-content">
                <h3>æ‰‹åŠ¨å–‚é£Ÿ</h3>
                <form id="manualFeedPopupForm" onsubmit="return false;">
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideManualFeedModal()">å–æ¶ˆ</button>
                        <button type="submit" class="feed-btn">ç«‹å³å–‚é£Ÿ</button>
                    </div>
                </form>
                <div id="manualFeedPopupMsg" class="msg"></div>
            </div>
        </div>
        <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
        <div class="modal delete-modal" id="deletePlanModal">
            <div class="modal-content">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <div>ç¡®å®šè¦åˆ é™¤è¯¥å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ</div>
                <div class="modal-actions">
                    <button type="button" onclick="hideDeletePlanModal()">å–æ¶ˆ</button>
                    <button type="button" id="deletePlanBtn">åˆ é™¤</button>
                </div>
                <div id="deletePlanMsg" class="msg"></div>
            </div>
        </div>
    </div>
    <script>
    // è°ƒè¯•ï¼šé¡µé¢åˆ·æ–°/è·³è½¬å’ŒWebSocketæ–­å¼€æç¤º
    window.addEventListener('beforeunload', function() {
        alert('é¡µé¢å³å°†åˆ·æ–°æˆ–è·³è½¬ï¼');
    });
    function setWsOnCloseDebug() {
        if (window.ws) {
            window.ws.onclose = function(e) {
                alert('WebSocketæ–­å¼€ï¼');
                console.log('WebSocketæ–­å¼€ï¼ŒåŸå› ï¼š', e);
            };
        }
    }
    window.addEventListener('load', setWsOnCloseDebug);
    
    // å…¨å±€åŒæ­¥çŠ¶æ€æ§åˆ¶
    let wsSyncing = false;
    
    // å®‰å…¨çš„é¡µé¢åˆ·æ–°å‡½æ•°
    function safeReload(delay = 0) {
        if (wsSyncing) {
            console.log('åŒæ­¥ä¸­ï¼Œç¦æ­¢é¡µé¢åˆ·æ–°');
            return;
        }
        if (delay > 0) {
            setTimeout(() => location.reload(), delay);
        } else {
            location.reload();
        }
    }
    
    // åªåœ¨é¡µé¢åŠ è½½æ—¶newä¸€æ¬¡WebSocket
    if (!window.ws) {
        const wsUrl = 'ws://' + location.hostname + ':8765';
        window.ws = new WebSocket(wsUrl);
        window.ws.onopen = function() {
            console.log('WSå·²è¿æ¥ï¼ŒçŠ¶æ€:', window.ws.readyState);
        };
        window.ws.onmessage = function(e) {
            console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', e.data);
            try {
                const msg = JSON.parse(e.data);
                handleSyncResult(msg);
                if (msg.type === 'sync_request_sent') {
                    console.log('åŒæ­¥è¯·æ±‚å·²å‘é€åˆ°è®¾å¤‡');
                } else if (msg.type === 'sync_request_failed') {
                    console.log('åŒæ­¥è¯·æ±‚å¤±è´¥:', msg.error);
                    wsSyncing = false;
                    syncBtn.innerText = 'ğŸ”„ æ•°æ®åŒæ­¥';
                    syncBtn.disabled = false;
                    alert('åŒæ­¥å¤±è´¥: ' + msg.error);
                }
            } catch(err) {
                console.log('è§£ææ¶ˆæ¯å¤±è´¥:', err);
            }
        };
        window.ws.onerror = function(e) {
            console.log('WSé”™è¯¯:', e);
        };
        setWsOnCloseDebug(); // è°ƒè¯•æ–­å¼€
    }
    // æ•°æ®åŒæ­¥æŒ‰é’®é€»è¾‘
    const syncBtn = document.getElementById('syncBtn');
    syncBtn.onclick = function() {
        if (wsSyncing) return;
        wsSyncing = true;
        syncBtn.innerText = 'åŒæ­¥ä¸­...';
        syncBtn.disabled = true;
        console.log('ç‚¹å‡»åŒæ­¥æŒ‰é’®');
        console.log('WebSocketçŠ¶æ€:', window.ws ? window.ws.readyState : 'æœªåˆ›å»º');
        // é€šè¿‡WebSocketä¸‹å‘åŒæ­¥è¯·æ±‚
        if (window.ws && window.ws.readyState === 1) {
            const syncMsg = {type: 'sync_request', device_id: '{{ device.device_id }}'};
            console.log('å‘é€åŒæ­¥è¯·æ±‚:', syncMsg);
            window.ws.send(JSON.stringify(syncMsg));
        } else {
            console.log('WebSocketæœªè¿æ¥ï¼ŒçŠ¶æ€:', window.ws ? window.ws.readyState : 'null');
            alert('WebSocketæœªè¿æ¥ï¼Œæ— æ³•åŒæ­¥');
            wsSyncing = false;
            syncBtn.innerText = 'ğŸ”„ æ•°æ®åŒæ­¥';
            syncBtn.disabled = false;
        }
    };
    // ç›‘å¬WebSocketåŒæ­¥å®Œæˆæ¶ˆæ¯
    function handleSyncResult(msg) {
        console.log('handleSyncResultæ”¶åˆ°æ¶ˆæ¯:', msg);
        if (msg.type === 'sync_result' && msg.device_id === '{{ device.device_id }}') {
            wsSyncing = false;
            syncBtn.innerText = 'ğŸ”„ æ•°æ®åŒæ­¥';
            syncBtn.disabled = false;
            alert('æ•°æ®åŒæ­¥å®Œæˆï¼');
            setTimeout(function() {
                location.reload();
            }, 500); // å»¶è¿Ÿ500mså†åˆ·æ–°ï¼Œä¿è¯æ¶ˆæ¯å¤„ç†å®Œæ¯•
        }
    }
    // åˆ é™¤å¼¹çª—æ§åˆ¶
    let deletePlanId = null;
    function confirmDeletePlan(id) {
        if (!id) return;
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ')) return;
        fetch('/delete_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({id: id})
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('åˆ é™¤æˆåŠŸï¼');
                safeReload();
            } else {
                alert(result.error || 'åˆ é™¤å¤±è´¥');
            }
        }).catch(()=>alert('ç½‘ç»œé”™è¯¯'));
    }
    function hideDeletePlanModal() {
        const modal = document.getElementById('deletePlanModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    document.getElementById('deletePlanBtn').onclick = async function() {
        if (!deletePlanId) return;
        document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
        document.getElementById('deletePlanMsg').className = 'msg loading';
        try {
            const res = await fetch('/delete_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id: deletePlanId})
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                document.getElementById('deletePlanMsg').className = 'msg success';
                safeReload(800);
            } else {
                document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        } catch(err) {
            document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
            document.getElementById('deletePlanMsg').className = 'msg error';
        }
    };
    // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
    ['deletePlanModal'].forEach(id=>{
        document.getElementById(id).onclick = function(e) {
            if(e.target === this) {
                this.classList.remove('show');
                setTimeout(() => {
                    this.style.display = 'none';
                }, 300);
            }
        };
    });
    // æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª—æ§åˆ¶
    function showPlanModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        const modal = document.getElementById('addPlanModal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        document.getElementById('addPlanMsg').innerText = '';
        document.getElementById('addPlanForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50ï¼Œæ˜ŸæœŸ
        const now = new Date();
        document.querySelector('#addPlanForm [name="hour"]').value = now.getHours();
        document.querySelector('#addPlanForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#addPlanForm [name="feeding_amount"]').value = 50;
        // JS: getDay() 0=å‘¨æ—¥, 1=å‘¨ä¸€... éœ€è½¬ä¸º1-7
        let jsDay = now.getDay();
        let planDay = jsDay === 0 ? 7 : jsDay;
        document.querySelector('#addPlanForm [name="day_of_week"]').value = planDay;
    }
    function hideAddPlanModal() {
        const modal = document.getElementById('addPlanModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    // ä¿®æ”¹æ·»åŠ å–‚é£Ÿè®¡åˆ’åç­‰å¾…è®¾å¤‡ç¡®è®¤é€»è¾‘ï¼Œæ”¯æŒé‡è¯•
    function waitForPlanConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5; // æ¯æ¬¡æœ€å¤šç­‰5æ¬¡ï¼ˆ5ç§’ï¼‰
        const maxSend = 3; // æœ€å¤šé‡å‘3æ¬¡
        const msgDiv = document.getElementById('addPlanMsg');
        msgDiv.innerText = `ç­‰å¾…è®¾å¤‡ç¡®è®¤...ï¼ˆç¬¬${tryCount}æ¬¡ï¼‰`;
        function poll() {
            fetch(`/get_feeding_plans?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    if (resp.feeding_plans && resp.feeding_plans.some(p =>
                        p.day_of_week == data.day_of_week &&
                        p.hour == data.hour &&
                        p.minute == data.minute &&
                        p.feeding_amount == data.feeding_amount
                    )) {
                        msgDiv.innerText = 'æ·»åŠ æˆåŠŸï¼';
                        safeReload(800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        // è¶…æ—¶é‡å‘
                        msgDiv.innerText = `ç¬¬${tryCount+1}æ¬¡é‡å‘...`;
                        sendPlanWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = 'ä¸‹å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = 'ç½‘ç»œé”™è¯¯';
                });
        }
        poll();
    }
    function sendPlanWithRetry(data, tryCount) {
        fetch('/add_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                waitForPlanConfirmWithRetry(data, tryCount);
            } else {
                document.getElementById('addPlanMsg').innerText = result.error || 'æ·»åŠ å¤±è´¥';
            }
        }).catch(()=>{
            document.getElementById('addPlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        });
    }
    if (document.getElementById('addPlanForm')) {
        document.getElementById('addPlanForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                day_of_week: form.day_of_week.value,
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('addPlanMsg').innerText = 'æäº¤ä¸­...';
            sendPlanWithRetry(data, 1);
        };
    }
    document.getElementById('addPlanModal').onclick = function(e) {
        if(e.target === this) {
            this.classList.remove('show');
            setTimeout(() => {
                this.style.display = 'none';
            }, 300);
        }
    };
    // æ‰‹åŠ¨å–‚é£Ÿå¼¹çª—æ§åˆ¶
    function showManualFeedModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        const modal = document.getElementById('manualFeedModal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        document.getElementById('manualFeedPopupMsg').innerText = '';
        document.getElementById('manualFeedPopupForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50
        const now = new Date();
        document.querySelector('#manualFeedPopupForm [name="hour"]').value = now.getHours();
        document.querySelector('#manualFeedPopupForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#manualFeedPopupForm [name="feeding_amount"]').value = 50;
    }
    function hideManualFeedModal() {
        const modal = document.getElementById('manualFeedModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    // æ‰‹åŠ¨å–‚é£Ÿé‡è¯•æœºåˆ¶
    function waitForManualConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5;
        const maxSend = 3;
        const msgDiv = document.getElementById('manualFeedPopupMsg');
        msgDiv.innerText = `ç­‰å¾…è®¾å¤‡ç¡®è®¤...ï¼ˆç¬¬${tryCount}æ¬¡ï¼‰`;
        function poll() {
            fetch(`/api/manual_feedings?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    // æ‰¾åˆ°å¯¹åº”è®°å½•
                    const m = resp.manual_feedings && resp.manual_feedings.find(m =>
                        m.hour == data.hour &&
                        m.minute == data.minute &&
                        m.feeding_amount == data.feeding_amount
                    );
                    if (m && m.is_confirmed) {
                        msgDiv.innerText = m.is_executed ? 'å–‚é£ŸæˆåŠŸï¼' : 'ä¸‹å‘æˆåŠŸï¼Œç­‰å¾…è®¾å¤‡æ‰§è¡Œ...';
                        safeReload(800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        msgDiv.innerText = `ç¬¬${tryCount+1}æ¬¡é‡å‘...`;
                        sendManualWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = 'ä¸‹å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = 'ç½‘ç»œé”™è¯¯';
                });
        }
        poll();
    }
    function sendManualWithRetry(data, tryCount) {
        fetch('/manual_feeding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                document.getElementById('manualFeedPopupMsg').innerText = 'ä¸‹å‘æˆåŠŸï¼Œç­‰å¾…è®¾å¤‡æ‰§è¡Œ...';
                safeReload(800);
            } else {
                document.getElementById('manualFeedPopupMsg').innerText = result.error || 'å–‚é£Ÿå¤±è´¥';
            }
        }).catch(()=>{
            document.getElementById('manualFeedPopupMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        });
    }
    if (document.getElementById('manualFeedPopupForm')) {
        document.getElementById('manualFeedPopupForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('manualFeedPopupMsg').innerText = 'æäº¤ä¸­...';
            sendManualWithRetry(data, 1);
        };
    }
    document.getElementById('manualFeedModal').onclick = function(e) {
        if(e.target === this) {
            this.classList.remove('show');
            setTimeout(() => {
                this.style.display = 'none';
            }, 300);
        }
    };
    // å–‚é£Ÿè®¡åˆ’æ˜ŸæœŸç­›é€‰
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const week = btn.getAttribute('data-week');
            document.querySelectorAll('.plan-row').forEach(row => {
                if (week === '0' || row.getAttribute('data-week') === week) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    });
    // åˆå¹¶å–‚é£Ÿè®¡åˆ’æ•°æ®
    const mergedPlansData = {{ merged_plans|tojson }};
    const mergedManualsData = {{ merged_manuals|tojson }};
    
    // æ–°å¢ï¼šæ‰¹é‡åˆ é™¤å–‚é£Ÿè®¡åˆ’å¼¹çª—æ§åˆ¶
    let deleteMergedKey = null;
    function confirmDeleteMergedPlan(key) {
        deleteMergedKey = key;
        const modal = document.getElementById('deletePlanModal');
        modal.style.display = 'flex';
        setTimeout(() => { modal.classList.add('show'); }, 10);
        document.getElementById('deletePlanMsg').innerText = '';
        document.getElementById('deletePlanMsg').className = 'msg';
        document.querySelector('#deletePlanModal h3').innerText = 'æ‰¹é‡åˆ é™¤';
        document.querySelector('#deletePlanModal .modal-content > div').innerText = 'ç¡®å®šè¦åˆ é™¤è¯¥æ—¶é—´ç‚¹çš„æ‰€æœ‰å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ';
        document.getElementById('deletePlanBtn').onclick = async function() {
            if (!deleteMergedKey) return;
            document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
            document.getElementById('deletePlanMsg').className = 'msg loading';
            try {
                const res = await fetch('/delete_feeding_plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merged_key: deleteMergedKey })
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                    document.getElementById('deletePlanMsg').className = 'msg success';
                    safeReload(800);
                } else {
                    document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
                    document.getElementById('deletePlanMsg').className = 'msg error';
                }
            } catch(err) {
                document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        };
    }
    // æ–°å¢ï¼šæ‰¹é‡åˆ é™¤æ‰‹åŠ¨å–‚é£Ÿå¼¹çª—æ§åˆ¶
    let deleteMergedManualKey = null;
    function confirmDeleteMergedManual(key) {
        deleteMergedManualKey = key;
        const modal = document.getElementById('deletePlanModal');
        modal.style.display = 'flex';
        setTimeout(() => { modal.classList.add('show'); }, 10);
        document.getElementById('deletePlanMsg').innerText = '';
        document.getElementById('deletePlanMsg').className = 'msg';
        document.querySelector('#deletePlanModal h3').innerText = 'æ‰¹é‡åˆ é™¤';
        document.querySelector('#deletePlanModal .modal-content > div').innerText = 'ç¡®å®šè¦åˆ é™¤è¯¥æ—¶é—´ç‚¹çš„æ‰€æœ‰å¾…æ‰§è¡Œæ‰‹åŠ¨å–‚é£Ÿå—ï¼Ÿ';
        document.getElementById('deletePlanBtn').onclick = async function() {
            if (!deleteMergedManualKey) return;
            document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
            document.getElementById('deletePlanMsg').className = 'msg loading';
            try {
                const res = await fetch('/delete_manual_feeding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merged_key: deleteMergedManualKey })
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                    document.getElementById('deletePlanMsg').className = 'msg success';
                    safeReload(800);
                } else {
                    document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
                    document.getElementById('deletePlanMsg').className = 'msg error';
                }
            } catch(err) {
                document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        };
    }
    // æ›¿æ¢åŸæœ‰æ‰¹é‡åˆ é™¤è°ƒç”¨
    function deleteMergedPlan(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        confirmDeleteMergedPlan(key);
    }
    function deleteMergedManual(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        confirmDeleteMergedManual(key);
    }
    // OTAå‡çº§è¡¨å•æäº¤
    const otaForm = document.getElementById('ota-form');
    const otaMsg = document.getElementById('ota-msg');
    otaForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        otaMsg.style.display = 'none';
        const url = document.getElementById('ota-url').value.trim();
        if (!url) return;
        otaMsg.textContent = 'æ­£åœ¨ä¸‹å‘OTAå‡çº§æŒ‡ä»¤...';
        otaMsg.style.display = 'block';
        try {
            const resp = await fetch('/ota_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json();
            if (data.status === 'success') {
                otaMsg.textContent = 'OTAå‡çº§æŒ‡ä»¤å·²ä¸‹å‘ï¼Œè¯·ç­‰å¾…è®¾å¤‡å“åº”ã€‚';
                otaMsg.style.color = '#388e3c';
            } else {
                otaMsg.textContent = data.error || 'OTAå‡çº§å¤±è´¥';
                otaMsg.style.color = '#e53935';
            }
        } catch (err) {
            otaMsg.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œå‡çº§æŒ‡ä»¤æœªä¸‹å‘';
            otaMsg.style.color = '#e53935';
        }
    });
    </script>
</body>
</html>
