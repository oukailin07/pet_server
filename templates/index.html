<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>宠物喂食器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f9fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .navbar {
            background: #2563eb;
            color: #fff;
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
        }
        .navbar .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .navbar .logo::before {
            content: '💙';
            font-size: 22px;
            margin-right: 8px;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .navbar .device-id {
            font-size: 15px;
            opacity: 0.92;
        }
        .navbar .logout {
            color: #fff;
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            opacity: 0.85;
        }
        .navbar .logout:hover {
            text-decoration: underline;
            opacity: 1;
        }
        .main-container {
            max-width: 1200px;
            margin: 32px auto 0 auto;
            padding: 0 16px;
        }
        .status-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 220px;
            min-width: 200px;
            background: linear-gradient(120deg, #4ade80 0%, #22d3ee 100%);
            color: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(34,211,238,0.08);
            padding: 24px 18px 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .status-card.status-online { background: linear-gradient(120deg, #34d399 0%, #38bdf8 100%); }
        .status-card.status-weight { background: linear-gradient(120deg, #6366f1 0%, #818cf8 100%); }
        .status-card.status-plan { background: linear-gradient(120deg, #fbbf24 0%, #f59e42 100%); }
        .status-card.status-heartbeat { background: linear-gradient(120deg, #38bdf8 0%, #818cf8 100%); }
        .status-card.status-chart { background: linear-gradient(120deg, #60a5fa 0%, #818cf8 100%); }
        .status-card .card-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-card .card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .status-card .card-desc {
            font-size: 14px;
            opacity: 0.92;
        }
        .status-card .card-icon {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 28px;
            opacity: 0.18;
        }
        .actions-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }
        .actions-bar button, .actions-bar .export-btn {
            padding: 8px 22px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .actions-bar .export-btn {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
            color: #fff;
        }
        .actions-bar button:hover, .actions-bar .export-btn:hover {
            filter: brightness(1.08);
        }
        .card-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(60, 120, 200, 0.06);
            margin-bottom: 22px;
            padding: 18px 22px 18px 22px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e3e3e3;
            padding: 10px 6px;
            text-align: center;
        }
        th {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .msg {
            text-align: center;
            color: #388e3c;
            font-size: 16px;
            margin: 8px 0 0 0;
        }
        .error {
            color: #e53935;
        }
        @media (max-width: 900px) {
            .status-cards { flex-direction: column; gap: 14px; }
            .main-container { padding: 0 2vw; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            padding: 0;
            min-width: 400px;
            max-width: 90vw;
            position: relative;
            transform: scale(0.9);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            margin: 0;
            padding: 24px 32px 16px 32px;
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-content h3::before {
            content: '⚠️';
            font-size: 24px;
        }
        /* 添加喂食计划弹框样式 */
        .add-plan-modal .modal-content h3::before {
            content: '📅';
        }
        /* 手动喂食弹框样式 */
        .manual-feed-modal .modal-content h3::before {
            content: '🍽️';
        }
        .modal-content > div:not(.modal-actions):not(.msg) {
            padding: 24px 32px;
            font-size: 16px;
            color: #4b5563;
            line-height: 1.6;
            text-align: center;
        }
        .modal-content form {
            padding: 24px 32px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 16px;
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            margin-top: 6px;
            transition: all 0.2s ease;
            background: #f9fafb;
        }
        .modal-content input:focus, .modal-content select:focus {
            outline: none;
            border-color: #2563eb;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .modal-content .add-plan-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .modal-content .add-plan-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        .modal-content .feed-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .modal-content .feed-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }
        .modal-actions {
            padding: 0 32px 24px 32px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .modal-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        .modal-actions button:first-child {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }
        .modal-actions button:first-child:hover {
            background: #e5e7eb;
            color: #374151;
        }
        .modal-actions button:last-child {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .modal-actions button:last-child:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        .modal-actions button:last-child:active {
            transform: translateY(0);
        }
        .msg {
            padding: 0 32px 16px 32px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }
        .msg.success {
            color: #059669;
        }
        .msg.error {
            color: #dc2626;
        }
        .msg.loading {
            color: #2563eb;
        }
        /* 删除确认弹框特殊样式 */
        .delete-modal .modal-content {
            border-top: 4px solid #ef4444;
        }
        .delete-modal .modal-content h3::before {
            content: '🗑️';
        }
        /* 响应式设计 */
        @media (max-width: 600px) {
            .modal-content {
                min-width: 90vw;
                margin: 20px;
            }
            .modal-content h3 {
                padding: 20px 24px 12px 24px;
                font-size: 18px;
            }
            .modal-content > div:not(.modal-actions):not(.msg) {
                padding: 20px 24px;
                font-size: 15px;
            }
            .modal-actions {
                padding: 0 24px 20px 24px;
                flex-direction: column;
            }
            .modal-actions button {
                width: 100%;
                padding: 14px 24px;
            }
        }
        .week-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .week-btn {
            padding: 5px 16px;
            border: none;
            border-radius: 5px;
            background: #e3e8ef;
            color: #2563eb;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .week-btn.active, .week-btn:hover {
            background: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">宠物喂食器</div>
        <div class="nav-right">
            <a href="/admin/versions" class="logout">版本管理</a>
            <span class="device-id">📋 {{ device.device_id }}</span>
            <a href="/logout" class="logout">退出</a>
        </div>
    </div>
    <div class="main-container">
        <div class="status-cards">
            <div class="status-card status-online">
                <div class="card-title">设备状态</div>
                <div class="card-value">{{ '在线' if device.is_online else '离线' }}</div>
                <div class="card-icon">📶</div>
            </div>
            <div class="status-card status-weight">
                <div class="card-title">粮桶重量</div>
                <div class="card-value">{{ device.grain_weight }}g</div>
                <div class="card-desc">更新时间: {{ last_grain_update_local.strftime('%H:%M:%S') if last_grain_update_local else '-' }}</div>
                <div style="position:absolute;top:18px;right:18px;display:flex;flex-direction:column;align-items:center;">
                    {% set percent = (device.grain_weight / 2000.0) if device.grain_weight < 2000 else 1.0 %}
                    <svg width="80" height="120" viewBox="0 0 80 120">
                        <defs>
                            <clipPath id="siloFillClip">
                                <rect x="20" y="22" width="40" height="60" rx="14"/>
                            </clipPath>
                        </defs>
                        <!-- 粮仓外轮廓 -->
                        <ellipse cx="40" cy="22" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <rect x="20" y="22" width="40" height="60" rx="14" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="82" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <!-- 粮食填充 -->
                        {% set fill_h = 60 * percent %}
                        <rect x="20" y="{{ 22+60-fill_h }}" width="40" height="{{ fill_h }}" fill="#7c4a03" clip-path="url(#siloFillClip)"/>
                        <!-- 高光 -->
                        <ellipse cx="32" cy="52" rx="5" ry="22" fill="#fff" fill-opacity="0.10"/>
                        <!-- 盖子 -->
                        <ellipse cx="40" cy="14" rx="22" ry="6" fill="#e0e0e0"/>
                        <ellipse cx="40" cy="14" rx="16" ry="4" fill="#fff" fill-opacity="0.7"/>
                        <!-- 出粮口 -->
                        <rect x="34" y="82" width="12" height="10" rx="4" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <ellipse cx="40" cy="92" rx="6" ry="3" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <!-- 碗 -->
                        <rect x="16" y="92" width="48" height="20" rx="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="112" rx="24" ry="6" fill="#e0e0e0"/>
                        <!-- 碗内粮食 -->
                        <ellipse cx="40" cy="104" rx="16" ry="5" fill="#7c4a03" fill-opacity="0.7"/>
                        <ellipse cx="40" cy="108" rx="12" ry="3" fill="#7c4a03" fill-opacity="0.5"/>
                    </svg>
                </div>
                <div style="width:100%;text-align:center;font-size:14px;font-weight:bold;color:#444;margin-top:8px;letter-spacing:1px;">总容量2000g</div>
            </div>
            <div class="status-card status-plan" style="position:relative;">
                <div class="card-title">喂食计划</div>
                <div class="card-value">{{ feeding_plans|length }}个</div>
                <div class="card-desc">活跃计划数量</div>
                <div class="card-icon">✅</div>
            </div>
            <div class="status-card status-chart" style="background:linear-gradient(120deg,#60a5fa 0%,#818cf8 100%);color:#fff;">
                <div class="card-title">喂食记录图表</div>
                <div class="card-value" style="margin-bottom:12px;">可视化分析</div>
                <button onclick="window.location.href='/feeding_chart'" style="padding:8px 18px;font-size:15px;border-radius:6px;background:#fff;color:#2563eb;border:none;cursor:pointer;font-weight:600;box-shadow:0 2px 8px #0002;">查看图表</button>
                <div class="card-desc" style="margin-top:10px;font-size:13px;opacity:0.92;">点击进入查看24小时喂食量统计</div>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="showPlanModal()" id="addPlanBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>➕ 添加喂食计划</button>
            <button onclick="showManualFeedModal()" id="manualFeedBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>🤲 手动喂食</button>
            <button id="syncBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>🔄 数据同步</button>
            <a class="export-btn" href="/export_feeding_records/{{ device.device_id }}">⬇️ 导出数据</a>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">📅</span>喂食计划</div>
            <table>
                <tr><th>星期</th><th>小时</th><th>分钟</th><th>总分量 (g)</th><th>操作</th></tr>
                {% for key, total in merged_plans.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ parts[0] }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ '%02d'|format(parts[2]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>
                        <button onclick="deleteMergedPlan('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">删除</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5">暂无喂食计划</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">🤲</span>手动喂食</div>
            <table>
                <tr><th>小时</th><th>分钟</th><th>总分量 (g)</th><th>状态</th><th>操作</th></tr>
                {% for key, total in merged_manuals.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ '%02d'|format(parts[0]|int) }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>
                        {% if parts[2] == '1' %}
                            已执行
                        {% else %}
                            待执行
                        {% endif %}
                    </td>
                    <td>
                        {% if parts[2] == '0' %}
                        <button onclick="deleteMergedManual('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">删除</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not merged_manuals %}
                <tr><td colspan="5">暂无手动喂食记录</td></tr>
                {% endif %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">🕒</span>最近喂食记录</div>
            <table>
                <tr><th>类型</th><th>星期</th><th>小时</th><th>分钟</th><th>分量 (g)</th><th>实际 (g)</th><th>状态</th><th>时间</th></tr>
                {% for record in recent_records %}
                <tr>
                    <td>计划</td>
                    <td>{{ record.day_of_week }}</td>
                    <td>{{ '%02d'|format(record.hour) }}</td>
                    <td>{{ '%02d'|format(record.minute) }}</td>
                    <td>{{ record.feeding_amount }}</td>
                    <td>{{ record.actual_amount }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.created_at_local.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
                {% for m in recent_manual_feedings %}
                {% if m.is_executed %}
                <tr>
                    <td>手动</td>
                    <td>-</td>
                    <td>{{ '%02d'|format(m.hour) }}</td>
                    <td>{{ '%02d'|format(m.minute) }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>已执行</td>
                    <td>{{ m.executed_at_local.strftime('%Y-%m-%d %H:%M:%S') if m.executed_at_local else '-' }}</td>
                </tr>
                {% endif %}
                {% endfor %}
                {% if not recent_records and not recent_manual_feedings %}
                <tr><td colspan="8">暂无喂食记录</td></tr>
                {% elif recent_records|length == 0 and recent_manual_feedings|selectattr('is_executed')|list|length == 0 %}
                <tr><td colspan="8">暂无喂食记录</td></tr>
                {% endif %}
            </table>
        </div>
        <div class="card-section" style="margin-bottom: 28px;">
            <div class="section-title"><span class="icon">🔄</span> 设备OTA固件升级</div>
            <form id="ota-form" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <input type="url" id="ota-url" name="ota_url" placeholder="请输入固件下载URL，如 http://your-server.com/firmware.bin" style="flex:1; min-width:220px; padding:10px 12px; border-radius:6px; border:1px solid #d1d5db; font-size:15px;" required>
                <button type="submit" style="padding:10px 28px; border:none; border-radius:6px; background:linear-gradient(90deg,#22d3ee 0%,#6366f1 100%); color:#fff; font-size:16px; font-weight:600; cursor:pointer; transition:background 0.2s;">立即升级</button>
            </form>
            <div id="ota-msg" class="msg" style="display:none;"></div>
        </div>
        <!-- 添加喂食计划弹窗 -->
        <div class="modal add-plan-modal" id="addPlanModal">
            <div class="modal-content">
                <h3>添加喂食计划</h3>
                <form id="addPlanForm" onsubmit="return false;">
                    <label>星期
                        <select name="day_of_week" required>
                            <option value="1">星期一</option>
                            <option value="2">星期二</option>
                            <option value="3">星期三</option>
                            <option value="4">星期四</option>
                            <option value="5">星期五</option>
                            <option value="6">星期六</option>
                            <option value="7">星期日</option>
                        </select>
                    </label>
                    <label>小时
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>分钟
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>分量 (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideAddPlanModal()">取消</button>
                        <button type="submit" class="add-plan-btn">添加</button>
                    </div>
                </form>
                <div id="addPlanMsg" class="msg"></div>
            </div>
        </div>
        <!-- 手动喂食弹窗 -->
        <div class="modal manual-feed-modal" id="manualFeedModal">
            <div class="modal-content">
                <h3>手动喂食</h3>
                <form id="manualFeedPopupForm" onsubmit="return false;">
                    <label>小时
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>分钟
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>分量 (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideManualFeedModal()">取消</button>
                        <button type="submit" class="feed-btn">立即喂食</button>
                    </div>
                </form>
                <div id="manualFeedPopupMsg" class="msg"></div>
            </div>
        </div>
        <!-- 删除确认弹窗 -->
        <div class="modal delete-modal" id="deletePlanModal">
            <div class="modal-content">
                <h3>确认删除</h3>
                <div>确定要删除该喂食计划吗？</div>
                <div class="modal-actions">
                    <button type="button" onclick="hideDeletePlanModal()">取消</button>
                    <button type="button" id="deletePlanBtn">删除</button>
                </div>
                <div id="deletePlanMsg" class="msg"></div>
            </div>
        </div>
    </div>
    <script>
    // 调试：页面刷新/跳转和WebSocket断开提示
    window.addEventListener('beforeunload', function() {
        alert('页面即将刷新或跳转！');
    });
    function setWsOnCloseDebug() {
        if (window.ws) {
            window.ws.onclose = function(e) {
                alert('WebSocket断开！');
                console.log('WebSocket断开，原因：', e);
            };
        }
    }
    window.addEventListener('load', setWsOnCloseDebug);
    
    // 全局同步状态控制
    let wsSyncing = false;
    
    // 安全的页面刷新函数
    function safeReload(delay = 0) {
        if (wsSyncing) {
            console.log('同步中，禁止页面刷新');
            return;
        }
        if (delay > 0) {
            setTimeout(() => location.reload(), delay);
        } else {
            location.reload();
        }
    }
    
    // 只在页面加载时new一次WebSocket
    if (!window.ws) {
        const wsUrl = 'ws://' + location.hostname + ':8765';
        window.ws = new WebSocket(wsUrl);
        window.ws.onopen = function() {
            console.log('WS已连接，状态:', window.ws.readyState);
        };
        window.ws.onmessage = function(e) {
            console.log('收到WebSocket消息:', e.data);
            try {
                const msg = JSON.parse(e.data);
                handleSyncResult(msg);
                if (msg.type === 'sync_request_sent') {
                    console.log('同步请求已发送到设备');
                } else if (msg.type === 'sync_request_failed') {
                    console.log('同步请求失败:', msg.error);
                    wsSyncing = false;
                    syncBtn.innerText = '🔄 数据同步';
                    syncBtn.disabled = false;
                    alert('同步失败: ' + msg.error);
                }
            } catch(err) {
                console.log('解析消息失败:', err);
            }
        };
        window.ws.onerror = function(e) {
            console.log('WS错误:', e);
        };
        setWsOnCloseDebug(); // 调试断开
    }
    // 数据同步按钮逻辑
    const syncBtn = document.getElementById('syncBtn');
    syncBtn.onclick = function() {
        if (wsSyncing) return;
        wsSyncing = true;
        syncBtn.innerText = '同步中...';
        syncBtn.disabled = true;
        console.log('点击同步按钮');
        console.log('WebSocket状态:', window.ws ? window.ws.readyState : '未创建');
        // 通过WebSocket下发同步请求
        if (window.ws && window.ws.readyState === 1) {
            const syncMsg = {type: 'sync_request', device_id: '{{ device.device_id }}'};
            console.log('发送同步请求:', syncMsg);
            window.ws.send(JSON.stringify(syncMsg));
        } else {
            console.log('WebSocket未连接，状态:', window.ws ? window.ws.readyState : 'null');
            alert('WebSocket未连接，无法同步');
            wsSyncing = false;
            syncBtn.innerText = '🔄 数据同步';
            syncBtn.disabled = false;
        }
    };
    // 监听WebSocket同步完成消息
    function handleSyncResult(msg) {
        console.log('handleSyncResult收到消息:', msg);
        if (msg.type === 'sync_result' && msg.device_id === '{{ device.device_id }}') {
            wsSyncing = false;
            syncBtn.innerText = '🔄 数据同步';
            syncBtn.disabled = false;
            alert('数据同步完成！');
            setTimeout(function() {
                location.reload();
            }, 500); // 延迟500ms再刷新，保证消息处理完毕
        }
    }
    // 删除弹窗控制
    let deletePlanId = null;
    function confirmDeletePlan(id) {
        if (!id) return;
        if (!confirm('确定要删除该喂食计划吗？')) return;
        fetch('/delete_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({id: id})
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('删除成功！');
                safeReload();
            } else {
                alert(result.error || '删除失败');
            }
        }).catch(()=>alert('网络错误'));
    }
    function hideDeletePlanModal() {
        const modal = document.getElementById('deletePlanModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    document.getElementById('deletePlanBtn').onclick = async function() {
        if (!deletePlanId) return;
        document.getElementById('deletePlanMsg').innerText = '删除中...';
        document.getElementById('deletePlanMsg').className = 'msg loading';
        try {
            const res = await fetch('/delete_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id: deletePlanId})
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('deletePlanMsg').innerText = '删除成功！';
                document.getElementById('deletePlanMsg').className = 'msg success';
                safeReload(800);
            } else {
                document.getElementById('deletePlanMsg').innerText = result.error || '删除失败';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        } catch(err) {
            document.getElementById('deletePlanMsg').innerText = '网络错误';
            document.getElementById('deletePlanMsg').className = 'msg error';
        }
    };
    // 点击弹窗外关闭
    ['deletePlanModal'].forEach(id=>{
        document.getElementById(id).onclick = function(e) {
            if(e.target === this) {
                this.classList.remove('show');
                setTimeout(() => {
                    this.style.display = 'none';
                }, 300);
            }
        };
    });
    // 添加喂食计划弹窗控制
    function showPlanModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('设备不在线，无法操作');
            return;
        }
        const modal = document.getElementById('addPlanModal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        document.getElementById('addPlanMsg').innerText = '';
        document.getElementById('addPlanForm').reset();
        // 设置默认值：当前时间，分量50，星期
        const now = new Date();
        document.querySelector('#addPlanForm [name="hour"]').value = now.getHours();
        document.querySelector('#addPlanForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#addPlanForm [name="feeding_amount"]').value = 50;
        // JS: getDay() 0=周日, 1=周一... 需转为1-7
        let jsDay = now.getDay();
        let planDay = jsDay === 0 ? 7 : jsDay;
        document.querySelector('#addPlanForm [name="day_of_week"]').value = planDay;
    }
    function hideAddPlanModal() {
        const modal = document.getElementById('addPlanModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    // 修改添加喂食计划后等待设备确认逻辑，支持重试
    function waitForPlanConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5; // 每次最多等5次（5秒）
        const maxSend = 3; // 最多重发3次
        const msgDiv = document.getElementById('addPlanMsg');
        msgDiv.innerText = `等待设备确认...（第${tryCount}次）`;
        function poll() {
            fetch(`/get_feeding_plans?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    if (resp.feeding_plans && resp.feeding_plans.some(p =>
                        p.day_of_week == data.day_of_week &&
                        p.hour == data.hour &&
                        p.minute == data.minute &&
                        p.feeding_amount == data.feeding_amount
                    )) {
                        msgDiv.innerText = '添加成功！';
                        safeReload(800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        // 超时重发
                        msgDiv.innerText = `第${tryCount+1}次重发...`;
                        sendPlanWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = '下发失败，请检查设备连接';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = '网络错误';
                });
        }
        poll();
    }
    function sendPlanWithRetry(data, tryCount) {
        fetch('/add_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                waitForPlanConfirmWithRetry(data, tryCount);
            } else {
                document.getElementById('addPlanMsg').innerText = result.error || '添加失败';
            }
        }).catch(()=>{
            document.getElementById('addPlanMsg').innerText = '网络错误';
        });
    }
    if (document.getElementById('addPlanForm')) {
        document.getElementById('addPlanForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                day_of_week: form.day_of_week.value,
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('addPlanMsg').innerText = '提交中...';
            sendPlanWithRetry(data, 1);
        };
    }
    document.getElementById('addPlanModal').onclick = function(e) {
        if(e.target === this) {
            this.classList.remove('show');
            setTimeout(() => {
                this.style.display = 'none';
            }, 300);
        }
    };
    // 手动喂食弹窗控制
    function showManualFeedModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('设备不在线，无法操作');
            return;
        }
        const modal = document.getElementById('manualFeedModal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        document.getElementById('manualFeedPopupMsg').innerText = '';
        document.getElementById('manualFeedPopupForm').reset();
        // 设置默认值：当前时间，分量50
        const now = new Date();
        document.querySelector('#manualFeedPopupForm [name="hour"]').value = now.getHours();
        document.querySelector('#manualFeedPopupForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#manualFeedPopupForm [name="feeding_amount"]').value = 50;
    }
    function hideManualFeedModal() {
        const modal = document.getElementById('manualFeedModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    // 手动喂食重试机制
    function waitForManualConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5;
        const maxSend = 3;
        const msgDiv = document.getElementById('manualFeedPopupMsg');
        msgDiv.innerText = `等待设备确认...（第${tryCount}次）`;
        function poll() {
            fetch(`/api/manual_feedings?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    // 找到对应记录
                    const m = resp.manual_feedings && resp.manual_feedings.find(m =>
                        m.hour == data.hour &&
                        m.minute == data.minute &&
                        m.feeding_amount == data.feeding_amount
                    );
                    if (m && m.is_confirmed) {
                        msgDiv.innerText = m.is_executed ? '喂食成功！' : '下发成功，等待设备执行...';
                        safeReload(800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        msgDiv.innerText = `第${tryCount+1}次重发...`;
                        sendManualWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = '下发失败，请检查设备连接';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = '网络错误';
                });
        }
        poll();
    }
    function sendManualWithRetry(data, tryCount) {
        fetch('/manual_feeding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                document.getElementById('manualFeedPopupMsg').innerText = '下发成功，等待设备执行...';
                safeReload(800);
            } else {
                document.getElementById('manualFeedPopupMsg').innerText = result.error || '喂食失败';
            }
        }).catch(()=>{
            document.getElementById('manualFeedPopupMsg').innerText = '网络错误';
        });
    }
    if (document.getElementById('manualFeedPopupForm')) {
        document.getElementById('manualFeedPopupForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('manualFeedPopupMsg').innerText = '提交中...';
            sendManualWithRetry(data, 1);
        };
    }
    document.getElementById('manualFeedModal').onclick = function(e) {
        if(e.target === this) {
            this.classList.remove('show');
            setTimeout(() => {
                this.style.display = 'none';
            }, 300);
        }
    };
    // 喂食计划星期筛选
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const week = btn.getAttribute('data-week');
            document.querySelectorAll('.plan-row').forEach(row => {
                if (week === '0' || row.getAttribute('data-week') === week) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    });
    // 合并喂食计划数据
    const mergedPlansData = {{ merged_plans|tojson }};
    const mergedManualsData = {{ merged_manuals|tojson }};
    
    // 新增：批量删除喂食计划弹窗控制
    let deleteMergedKey = null;
    function confirmDeleteMergedPlan(key) {
        deleteMergedKey = key;
        const modal = document.getElementById('deletePlanModal');
        modal.style.display = 'flex';
        setTimeout(() => { modal.classList.add('show'); }, 10);
        document.getElementById('deletePlanMsg').innerText = '';
        document.getElementById('deletePlanMsg').className = 'msg';
        document.querySelector('#deletePlanModal h3').innerText = '批量删除';
        document.querySelector('#deletePlanModal .modal-content > div').innerText = '确定要删除该时间点的所有喂食计划吗？';
        document.getElementById('deletePlanBtn').onclick = async function() {
            if (!deleteMergedKey) return;
            document.getElementById('deletePlanMsg').innerText = '删除中...';
            document.getElementById('deletePlanMsg').className = 'msg loading';
            try {
                const res = await fetch('/delete_feeding_plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merged_key: deleteMergedKey })
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('deletePlanMsg').innerText = '删除成功！';
                    document.getElementById('deletePlanMsg').className = 'msg success';
                    safeReload(800);
                } else {
                    document.getElementById('deletePlanMsg').innerText = result.error || '删除失败';
                    document.getElementById('deletePlanMsg').className = 'msg error';
                }
            } catch(err) {
                document.getElementById('deletePlanMsg').innerText = '网络错误';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        };
    }
    // 新增：批量删除手动喂食弹窗控制
    let deleteMergedManualKey = null;
    function confirmDeleteMergedManual(key) {
        deleteMergedManualKey = key;
        const modal = document.getElementById('deletePlanModal');
        modal.style.display = 'flex';
        setTimeout(() => { modal.classList.add('show'); }, 10);
        document.getElementById('deletePlanMsg').innerText = '';
        document.getElementById('deletePlanMsg').className = 'msg';
        document.querySelector('#deletePlanModal h3').innerText = '批量删除';
        document.querySelector('#deletePlanModal .modal-content > div').innerText = '确定要删除该时间点的所有待执行手动喂食吗？';
        document.getElementById('deletePlanBtn').onclick = async function() {
            if (!deleteMergedManualKey) return;
            document.getElementById('deletePlanMsg').innerText = '删除中...';
            document.getElementById('deletePlanMsg').className = 'msg loading';
            try {
                const res = await fetch('/delete_manual_feeding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ merged_key: deleteMergedManualKey })
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('deletePlanMsg').innerText = '删除成功！';
                    document.getElementById('deletePlanMsg').className = 'msg success';
                    safeReload(800);
                } else {
                    document.getElementById('deletePlanMsg').innerText = result.error || '删除失败';
                    document.getElementById('deletePlanMsg').className = 'msg error';
                }
            } catch(err) {
                document.getElementById('deletePlanMsg').innerText = '网络错误';
                document.getElementById('deletePlanMsg').className = 'msg error';
            }
        };
    }
    // 替换原有批量删除调用
    function deleteMergedPlan(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('设备不在线，无法操作');
            return;
        }
        confirmDeleteMergedPlan(key);
    }
    function deleteMergedManual(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('设备不在线，无法操作');
            return;
        }
        confirmDeleteMergedManual(key);
    }
    // OTA升级表单提交
    const otaForm = document.getElementById('ota-form');
    const otaMsg = document.getElementById('ota-msg');
    otaForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        otaMsg.style.display = 'none';
        const url = document.getElementById('ota-url').value.trim();
        if (!url) return;
        otaMsg.textContent = '正在下发OTA升级指令...';
        otaMsg.style.display = 'block';
        try {
            const resp = await fetch('/ota_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await resp.json();
            if (data.status === 'success') {
                otaMsg.textContent = 'OTA升级指令已下发，请等待设备响应。';
                otaMsg.style.color = '#388e3c';
            } else {
                otaMsg.textContent = data.error || 'OTA升级失败';
                otaMsg.style.color = '#e53935';
            }
        } catch (err) {
            otaMsg.textContent = '网络错误，升级指令未下发';
            otaMsg.style.color = '#e53935';
        }
    });
    </script>
</body>
</html>
