<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å® ç‰©å–‚é£Ÿå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f9fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .navbar {
            background: #2563eb;
            color: #fff;
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
        }
        .navbar .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .navbar .logo::before {
            content: 'ğŸ’™';
            font-size: 22px;
            margin-right: 8px;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .navbar .device-id {
            font-size: 15px;
            opacity: 0.92;
        }
        .navbar .logout {
            color: #fff;
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            opacity: 0.85;
        }
        .navbar .logout:hover {
            text-decoration: underline;
            opacity: 1;
        }
        .main-container {
            max-width: 1200px;
            margin: 32px auto 0 auto;
            padding: 0 16px;
        }
        .status-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 220px;
            min-width: 200px;
            background: linear-gradient(120deg, #4ade80 0%, #22d3ee 100%);
            color: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(34,211,238,0.08);
            padding: 24px 18px 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .status-card.status-online { background: linear-gradient(120deg, #34d399 0%, #38bdf8 100%); }
        .status-card.status-weight { background: linear-gradient(120deg, #6366f1 0%, #818cf8 100%); }
        .status-card.status-plan { background: linear-gradient(120deg, #fbbf24 0%, #f59e42 100%); }
        .status-card.status-heartbeat { background: linear-gradient(120deg, #38bdf8 0%, #818cf8 100%); }
        .status-card .card-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-card .card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .status-card .card-desc {
            font-size: 14px;
            opacity: 0.92;
        }
        .status-card .card-icon {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 28px;
            opacity: 0.18;
        }
        .actions-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }
        .actions-bar button, .actions-bar .export-btn {
            padding: 8px 22px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .actions-bar .export-btn {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
            color: #fff;
        }
        .actions-bar button:hover, .actions-bar .export-btn:hover {
            filter: brightness(1.08);
        }
        .card-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(60, 120, 200, 0.06);
            margin-bottom: 22px;
            padding: 18px 22px 18px 22px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e3e3e3;
            padding: 10px 6px;
            text-align: center;
        }
        th {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .msg {
            text-align: center;
            color: #388e3c;
            font-size: 16px;
            margin: 8px 0 0 0;
        }
        .error {
            color: #e53935;
        }
        @media (max-width: 900px) {
            .status-cards { flex-direction: column; gap: 14px; }
            .main-container { padding: 0 2vw; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.35); /* åŠé€æ˜é®ç½© */
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 90vw;
            position: relative;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 16px;
            animation: modalPopIn 0.18s cubic-bezier(.4,1.4,.6,1) 1;
        }
        @keyframes modalPopIn {
            0% { transform: scale(0.92) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-actions {
            display: flex;
            gap: 18px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .modal-content h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #2563eb;
            font-weight: 600;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 15px;
            margin-top: 4px;
            margin-bottom: 10px;
        }
        .modal-content button {
            padding: 7px 22px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .modal-content button[type="button"] {
            background: #e3e3e3;
            color: #333;
        }
        .modal-content button[type="button"]:hover {
            background: #c7c7c7;
        }
        .modal-content button[type="submit"]:hover {
            filter: brightness(1.08);
        }
        .modal .msg {
            margin-top: 8px;
            text-align: left;
        }
        @media (max-width: 600px) {
            .modal-content { min-width: 90vw; padding: 18px 8vw 18px 8vw; }
        }
        .week-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .week-btn {
            padding: 5px 16px;
            border: none;
            border-radius: 5px;
            background: #e3e8ef;
            color: #2563eb;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .week-btn.active, .week-btn:hover {
            background: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">å® ç‰©å–‚é£Ÿå™¨</div>
        <div class="nav-right">
            <span class="device-id">ğŸ“‹ {{ device.device_id }}</span>
            <a href="/logout" class="logout">é€€å‡º</a>
        </div>
    </div>
    <div class="main-container">
        <div class="status-cards">
            <div class="status-card status-online">
                <div class="card-title">è®¾å¤‡çŠ¶æ€</div>
                <div class="card-value">{{ 'åœ¨çº¿' if device.is_online else 'ç¦»çº¿' }}</div>
                <div class="card-desc">æœ€åå¿ƒè·³: {{ last_seen_local.strftime('%H:%M:%S') if last_seen_local else '-' }}</div>
                <div class="card-icon">ğŸ“¶</div>
            </div>
            <div class="status-card status-weight">
                <div class="card-title">ç²®æ¡¶é‡é‡</div>
                <div class="card-value">{{ device.grain_weight }}g</div>
                <div class="card-desc">æ›´æ–°æ—¶é—´: {{ last_grain_update_local.strftime('%H:%M:%S') if last_grain_update_local else '-' }}</div>
                <div class="card-icon">ğŸ“¦</div>
            </div>
            <div class="status-card status-plan">
                <div class="card-title">å–‚é£Ÿè®¡åˆ’</div>
                <div class="card-value">{{ feeding_plans|length }}ä¸ª</div>
                <div class="card-desc">æ´»è·ƒè®¡åˆ’æ•°é‡</div>
                <div class="card-icon">âœ…</div>
            </div>
            <div class="status-card status-heartbeat">
                <div class="card-title">å¿ƒè·³æ¬¡æ•°</div>
                <div class="card-value">{{ device.heartbeat_count }}</div>
                <div class="card-desc">è®¾å¤‡è¿æ¥æ¬¡æ•°</div>
                <div class="card-icon">â°</div>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="showPlanModal()">â• æ·»åŠ å–‚é£Ÿè®¡åˆ’</button>
            <button onclick="showManualFeedModal()">ğŸ¤² æ‰‹åŠ¨å–‚é£Ÿ</button>
            <button onclick="location.reload()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <a class="export-btn" href="/export_feeding_records/{{ device.device_id }}">â¬‡ï¸ å¯¼å‡ºæ•°æ®</a>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ“…</span>åˆå¹¶åå–‚é£Ÿè®¡åˆ’</div>
            <table>
                <tr><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th></tr>
                {% for key, total in merged_plans.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ parts[0] }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ '%02d'|format(parts[2]|int) }}</td>
                    <td>{{ total }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">æš‚æ— å–‚é£Ÿè®¡åˆ’</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ¤²</span>åˆå¹¶åæ‰‹åŠ¨å–‚é£Ÿè®°å½•</div>
            <table>
                <tr><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th><th>çŠ¶æ€</th></tr>
                {% for key, total in merged_manuals.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ '%02d'|format(parts[0]|int) }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>{{ 'å·²æ‰§è¡Œ' if parts[2] == '1' else 'å¾…æ‰§è¡Œ' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">æš‚æ— æ‰‹åŠ¨å–‚é£Ÿè®°å½•</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ•’</span>æœ€è¿‘å–‚é£Ÿè®°å½•</div>
            <table>
                <tr><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>åˆ†é‡ (g)</th><th>å®é™… (g)</th><th>çŠ¶æ€</th><th>æ—¶é—´</th></tr>
                {% for record in recent_records %}
                <tr>
                    <td>{{ record.day_of_week }}</td>
                    <td>{{ '%02d'|format(record.hour) }}</td>
                    <td>{{ '%02d'|format(record.minute) }}</td>
                    <td>{{ record.feeding_amount }}</td>
                    <td>{{ record.actual_amount }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% else %}
                <tr><td colspan="7">æš‚æ— å–‚é£Ÿè®°å½•</td></tr>
                {% endfor %}
            </table>
        </div>
        <!-- æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª— -->
        <div class="modal" id="addPlanModal">
            <div class="modal-content">
                <h3>æ·»åŠ å–‚é£Ÿè®¡åˆ’</h3>
                <form id="addPlanForm" onsubmit="return false;">
                    <label>æ˜ŸæœŸ
                        <select name="day_of_week" required>
                            <option value="1">æ˜ŸæœŸä¸€</option>
                            <option value="2">æ˜ŸæœŸäºŒ</option>
                            <option value="3">æ˜ŸæœŸä¸‰</option>
                            <option value="4">æ˜ŸæœŸå››</option>
                            <option value="5">æ˜ŸæœŸäº”</option>
                            <option value="6">æ˜ŸæœŸå…­</option>
                            <option value="7">æ˜ŸæœŸæ—¥</option>
                        </select>
                    </label>
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideAddPlanModal()">å–æ¶ˆ</button>
                        <button type="submit" class="add-plan-btn">æ·»åŠ </button>
                    </div>
                </form>
                <div id="addPlanMsg" class="msg"></div>
            </div>
        </div>
        <!-- æ‰‹åŠ¨å–‚é£Ÿå¼¹çª— -->
        <div class="modal" id="manualFeedModal">
            <div class="modal-content">
                <h3>æ‰‹åŠ¨å–‚é£Ÿ</h3>
                <form id="manualFeedPopupForm" onsubmit="return false;">
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideManualFeedModal()">å–æ¶ˆ</button>
                        <button type="submit" class="feed-btn">ç«‹å³å–‚é£Ÿ</button>
                    </div>
                </form>
                <div id="manualFeedPopupMsg" class="msg"></div>
            </div>
        </div>
        <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
        <div class="modal" id="deletePlanModal">
            <div class="modal-content">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <div>ç¡®å®šè¦åˆ é™¤è¯¥å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ</div>
                <div class="modal-actions">
                    <button type="button" onclick="hideDeletePlanModal()">å–æ¶ˆ</button>
                    <button type="button" id="deletePlanBtn" style="background:#e53935; color:#fff;">åˆ é™¤</button>
                </div>
                <div id="deletePlanMsg" class="msg"></div>
            </div>
        </div>
    </div>
    <script>
    // åˆ é™¤å¼¹çª—æ§åˆ¶
    let deletePlanId = null;
    function confirmDeletePlan(id) {
        deletePlanId = id;
        document.getElementById('deletePlanModal').style.display = 'flex';
        document.getElementById('deletePlanMsg').innerText = '';
    }
    function hideDeletePlanModal() {
        document.getElementById('deletePlanModal').style.display = 'none';
    }
    document.getElementById('deletePlanBtn').onclick = async function() {
        if (!deletePlanId) return;
        document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
        try {
            const res = await fetch('/delete_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id: deletePlanId})
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
            }
        } catch(err) {
            document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        }
    };
    // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
    ['deletePlanModal'].forEach(id=>{
        document.getElementById(id).onclick = function(e) {
            if(e.target === this) this.style.display = 'none';
        };
    });
    // æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª—æ§åˆ¶
    function showPlanModal() {
        document.getElementById('addPlanModal').style.display = 'flex';
        document.getElementById('addPlanMsg').innerText = '';
        document.getElementById('addPlanForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50ï¼Œæ˜ŸæœŸ
        const now = new Date();
        document.querySelector('#addPlanForm [name="hour"]').value = now.getHours();
        document.querySelector('#addPlanForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#addPlanForm [name="feeding_amount"]').value = 50;
        // JS: getDay() 0=å‘¨æ—¥, 1=å‘¨ä¸€... éœ€è½¬ä¸º1-7
        let jsDay = now.getDay();
        let planDay = jsDay === 0 ? 7 : jsDay;
        document.querySelector('#addPlanForm [name="day_of_week"]').value = planDay;
    }
    function hideAddPlanModal() {
        document.getElementById('addPlanModal').style.display = 'none';
    }
    document.getElementById('addPlanForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            device_id: "{{ device.device_id }}",
            day_of_week: form.day_of_week.value,
            hour: form.hour.value,
            minute: form.minute.value,
            feeding_amount: form.feeding_amount.value
        };
        document.getElementById('addPlanMsg').innerText = 'æäº¤ä¸­...';
        try {
            const res = await fetch('/add_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('addPlanMsg').innerText = 'æ·»åŠ æˆåŠŸï¼';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('addPlanMsg').innerText = result.error || 'æ·»åŠ å¤±è´¥';
            }
        } catch(err) {
            document.getElementById('addPlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        }
    };
    document.getElementById('addPlanModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // æ‰‹åŠ¨å–‚é£Ÿå¼¹çª—æ§åˆ¶
    function showManualFeedModal() {
        document.getElementById('manualFeedModal').style.display = 'flex';
        document.getElementById('manualFeedPopupMsg').innerText = '';
        document.getElementById('manualFeedPopupForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50
        const now = new Date();
        document.querySelector('#manualFeedPopupForm [name="hour"]').value = now.getHours();
        document.querySelector('#manualFeedPopupForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#manualFeedPopupForm [name="feeding_amount"]').value = 50;
    }
    function hideManualFeedModal() {
        document.getElementById('manualFeedModal').style.display = 'none';
    }
    document.getElementById('manualFeedPopupForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            device_id: "{{ device.device_id }}",
            hour: form.hour.value,
            minute: form.minute.value,
            feeding_amount: form.feeding_amount.value
        };
        document.getElementById('manualFeedPopupMsg').innerText = 'æäº¤ä¸­...';
        try {
            const res = await fetch('/manual_feeding', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('manualFeedPopupMsg').innerText = 'å–‚é£ŸæˆåŠŸï¼';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('manualFeedPopupMsg').innerText = result.error || 'å–‚é£Ÿå¤±è´¥';
            }
        } catch(err) {
            document.getElementById('manualFeedPopupMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        }
    };
    document.getElementById('manualFeedModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // å–‚é£Ÿè®¡åˆ’æ˜ŸæœŸç­›é€‰
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const week = btn.getAttribute('data-week');
            document.querySelectorAll('.plan-row').forEach(row => {
                if (week === '0' || row.getAttribute('data-week') === week) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    });
    // åˆå¹¶å–‚é£Ÿè®¡åˆ’
    {% set merged_plans = {} %}
    {% for plan in feeding_plans %}
        {% set key = plan.day_of_week ~ '-' ~ plan.hour ~ '-' ~ plan.minute %}
        {% if key in merged_plans %}
            {% set _ = merged_plans.__setitem__(key, merged_plans[key] + plan.feeding_amount) %}
        {% else %}
            {% set _ = merged_plans.__setitem__(key, plan.feeding_amount) %}
        {% endif %}
    {% endfor %}
    // åˆå¹¶æ‰‹åŠ¨å–‚é£Ÿ
    {% set merged_manuals = {} %}
    {% for m in recent_manual_feedings %}
        {% set key = m.hour ~ '-' ~ m.minute ~ '-' ~ (m.is_executed and '1' or '0') %}
        {% if key in merged_manuals %}
            {% set _ = merged_manuals.__setitem__(key, merged_manuals[key] + m.feeding_amount) %}
        {% else %}
            {% set _ = merged_manuals.__setitem__(key, m.feeding_amount) %}
        {% endif %}
    {% endfor %}
    </script>
</body>
</html>
