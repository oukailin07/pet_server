<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ÂÆ†Áâ©ÂñÇÈ£üÂô®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f9fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .navbar {
            background: #2563eb;
            color: #fff;
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
        }
        .navbar .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .navbar .logo::before {
            content: 'üíô';
            font-size: 22px;
            margin-right: 8px;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .navbar .device-id {
            font-size: 15px;
            opacity: 0.92;
        }
        .navbar .logout {
            color: #fff;
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            opacity: 0.85;
        }
        .navbar .logout:hover {
            text-decoration: underline;
            opacity: 1;
        }
        .main-container {
            max-width: 1200px;
            margin: 32px auto 0 auto;
            padding: 0 16px;
        }
        .status-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 220px;
            min-width: 200px;
            background: linear-gradient(120deg, #4ade80 0%, #22d3ee 100%);
            color: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(34,211,238,0.08);
            padding: 24px 18px 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .status-card.status-online { background: linear-gradient(120deg, #34d399 0%, #38bdf8 100%); }
        .status-card.status-weight { background: linear-gradient(120deg, #6366f1 0%, #818cf8 100%); }
        .status-card.status-plan { background: linear-gradient(120deg, #fbbf24 0%, #f59e42 100%); }
        .status-card.status-heartbeat { background: linear-gradient(120deg, #38bdf8 0%, #818cf8 100%); }
        .status-card .card-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-card .card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .status-card .card-desc {
            font-size: 14px;
            opacity: 0.92;
        }
        .status-card .card-icon {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 28px;
            opacity: 0.18;
        }
        .actions-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }
        .actions-bar button, .actions-bar .export-btn {
            padding: 8px 22px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .actions-bar .export-btn {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
            color: #fff;
        }
        .actions-bar button:hover, .actions-bar .export-btn:hover {
            filter: brightness(1.08);
        }
        .card-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(60, 120, 200, 0.06);
            margin-bottom: 22px;
            padding: 18px 22px 18px 22px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e3e3e3;
            padding: 10px 6px;
            text-align: center;
        }
        th {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .msg {
            text-align: center;
            color: #388e3c;
            font-size: 16px;
            margin: 8px 0 0 0;
        }
        .error {
            color: #e53935;
        }
        @media (max-width: 900px) {
            .status-cards { flex-direction: column; gap: 14px; }
            .main-container { padding: 0 2vw; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.35); /* ÂçäÈÄèÊòéÈÅÆÁΩ© */
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 90vw;
            position: relative;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 16px;
            animation: modalPopIn 0.18s cubic-bezier(.4,1.4,.6,1) 1;
        }
        @keyframes modalPopIn {
            0% { transform: scale(0.92) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-actions {
            display: flex;
            gap: 18px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .modal-content h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #2563eb;
            font-weight: 600;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 15px;
            margin-top: 4px;
            margin-bottom: 10px;
        }
        .modal-content button {
            padding: 7px 22px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .modal-content button[type="button"] {
            background: #e3e3e3;
            color: #333;
        }
        .modal-content button[type="button"]:hover {
            background: #c7c7c7;
        }
        .modal-content button[type="submit"]:hover {
            filter: brightness(1.08);
        }
        .modal .msg {
            margin-top: 8px;
            text-align: left;
        }
        @media (max-width: 600px) {
            .modal-content { min-width: 90vw; padding: 18px 8vw 18px 8vw; }
        }
        .week-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .week-btn {
            padding: 5px 16px;
            border: none;
            border-radius: 5px;
            background: #e3e8ef;
            color: #2563eb;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .week-btn.active, .week-btn:hover {
            background: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">ÂÆ†Áâ©ÂñÇÈ£üÂô®</div>
        <div class="nav-right">
            <span class="device-id">üìã {{ device.device_id }}</span>
            <a href="/logout" class="logout">ÈÄÄÂá∫</a>
        </div>
    </div>
    <div class="main-container">
        <div class="status-cards">
            <div class="status-card status-online">
                <div class="card-title">ËÆæÂ§áÁä∂ÊÄÅ</div>
                <div class="card-value">{{ 'Âú®Á∫ø' if device.is_online else 'Á¶ªÁ∫ø' }}</div>
                <div class="card-desc">ÊúÄÂêéÂøÉË∑≥: {{ last_seen_local.strftime('%H:%M:%S') if last_seen_local else '-' }}</div>
                <div class="card-icon">üì∂</div>
            </div>
            <div class="status-card status-weight">
                <div class="card-title">Á≤ÆÊ°∂ÈáçÈáè</div>
                <div class="card-value">{{ device.grain_weight }}g</div>
                <div class="card-desc">Êõ¥Êñ∞Êó∂Èó¥: {{ last_grain_update_local.strftime('%H:%M:%S') if last_grain_update_local else '-' }}</div>
                <div class="card-icon">üì¶</div>
            </div>
            <div class="status-card status-plan">
                <div class="card-title">ÂñÇÈ£üËÆ°Âàí</div>
                <div class="card-value">{{ feeding_plans|length }}‰∏™</div>
                <div class="card-desc">Ê¥ªË∑ÉËÆ°ÂàíÊï∞Èáè</div>
                <div class="card-icon">‚úÖ</div>
            </div>
            <div class="status-card status-heartbeat">
                <div class="card-title">ÂøÉË∑≥Ê¨°Êï∞</div>
                <div class="card-value">{{ device.heartbeat_count }}</div>
                <div class="card-desc">ËÆæÂ§áËøûÊé•Ê¨°Êï∞</div>
                <div class="card-icon">‚è∞</div>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="showPlanModal()">‚ûï Ê∑ªÂä†ÂñÇÈ£üËÆ°Âàí</button>
            <button onclick="showManualFeedModal()">ü§≤ ÊâãÂä®ÂñÇÈ£ü</button>
            <button onclick="location.reload()">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
            <a class="export-btn" href="/export_feeding_records/{{ device.device_id }}">‚¨áÔ∏è ÂØºÂá∫Êï∞ÊçÆ</a>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">üìÖ</span>ÂêàÂπ∂ÂêéÂñÇÈ£üËÆ°Âàí</div>
            <table>
                <tr><th>ÊòüÊúü</th><th>Â∞èÊó∂</th><th>ÂàÜÈíü</th><th>ÊÄªÂàÜÈáè (g)</th></tr>
                {% for key, total in merged_plans.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ parts[0] }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ '%02d'|format(parts[2]|int) }}</td>
                    <td>{{ total }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">ÊöÇÊó†ÂñÇÈ£üËÆ°Âàí</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ü§≤</span>ÂêàÂπ∂ÂêéÊâãÂä®ÂñÇÈ£üËÆ∞ÂΩï</div>
            <table>
                <tr><th>Â∞èÊó∂</th><th>ÂàÜÈíü</th><th>ÊÄªÂàÜÈáè (g)</th><th>Áä∂ÊÄÅ</th></tr>
                {% for key, total in merged_manuals.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ '%02d'|format(parts[0]|int) }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>{{ 'Â∑≤ÊâßË°å' if parts[2] == '1' else 'ÂæÖÊâßË°å' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">ÊöÇÊó†ÊâãÂä®ÂñÇÈ£üËÆ∞ÂΩï</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">üïí</span>ÊúÄËøëÂñÇÈ£üËÆ∞ÂΩï</div>
            <table>
                <tr><th>ÊòüÊúü</th><th>Â∞èÊó∂</th><th>ÂàÜÈíü</th><th>ÂàÜÈáè (g)</th><th>ÂÆûÈôÖ (g)</th><th>Áä∂ÊÄÅ</th><th>Êó∂Èó¥</th></tr>
                {% for record in recent_records %}
                <tr>
                    <td>{{ record.day_of_week }}</td>
                    <td>{{ '%02d'|format(record.hour) }}</td>
                    <td>{{ '%02d'|format(record.minute) }}</td>
                    <td>{{ record.feeding_amount }}</td>
                    <td>{{ record.actual_amount }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% else %}
                <tr><td colspan="7">ÊöÇÊó†ÂñÇÈ£üËÆ∞ÂΩï</td></tr>
                {% endfor %}
            </table>
        </div>
        <!-- Ê∑ªÂä†ÂñÇÈ£üËÆ°ÂàíÂºπÁ™ó -->
        <div class="modal" id="addPlanModal">
            <div class="modal-content">
                <h3>Ê∑ªÂä†ÂñÇÈ£üËÆ°Âàí</h3>
                <form id="addPlanForm" onsubmit="return false;">
                    <label>ÊòüÊúü
                        <select name="day_of_week" required>
                            <option value="1">ÊòüÊúü‰∏Ä</option>
                            <option value="2">ÊòüÊúü‰∫å</option>
                            <option value="3">ÊòüÊúü‰∏â</option>
                            <option value="4">ÊòüÊúüÂõõ</option>
                            <option value="5">ÊòüÊúü‰∫î</option>
                            <option value="6">ÊòüÊúüÂÖ≠</option>
                            <option value="7">ÊòüÊúüÊó•</option>
                        </select>
                    </label>
                    <label>Â∞èÊó∂
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>ÂàÜÈíü
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>ÂàÜÈáè (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideAddPlanModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="add-plan-btn">Ê∑ªÂä†</button>
                    </div>
                </form>
                <div id="addPlanMsg" class="msg"></div>
            </div>
        </div>
        <!-- ÊâãÂä®ÂñÇÈ£üÂºπÁ™ó -->
        <div class="modal" id="manualFeedModal">
            <div class="modal-content">
                <h3>ÊâãÂä®ÂñÇÈ£ü</h3>
                <form id="manualFeedPopupForm" onsubmit="return false;">
                    <label>Â∞èÊó∂
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>ÂàÜÈíü
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>ÂàÜÈáè (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideManualFeedModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="feed-btn">Á´ãÂç≥ÂñÇÈ£ü</button>
                    </div>
                </form>
                <div id="manualFeedPopupMsg" class="msg"></div>
            </div>
        </div>
        <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
        <div class="modal" id="deletePlanModal">
            <div class="modal-content">
                <h3>Á°ÆËÆ§Âà†Èô§</h3>
                <div>Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ÂñÇÈ£üËÆ°ÂàíÂêóÔºü</div>
                <div class="modal-actions">
                    <button type="button" onclick="hideDeletePlanModal()">ÂèñÊ∂à</button>
                    <button type="button" id="deletePlanBtn" style="background:#e53935; color:#fff;">Âà†Èô§</button>
                </div>
                <div id="deletePlanMsg" class="msg"></div>
            </div>
        </div>
    </div>
    <script>
    // Âà†Èô§ÂºπÁ™óÊéßÂà∂
    let deletePlanId = null;
    function confirmDeletePlan(id) {
        deletePlanId = id;
        document.getElementById('deletePlanModal').style.display = 'flex';
        document.getElementById('deletePlanMsg').innerText = '';
    }
    function hideDeletePlanModal() {
        document.getElementById('deletePlanModal').style.display = 'none';
    }
    document.getElementById('deletePlanBtn').onclick = async function() {
        if (!deletePlanId) return;
        document.getElementById('deletePlanMsg').innerText = 'Âà†Èô§‰∏≠...';
        try {
            const res = await fetch('/delete_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id: deletePlanId})
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('deletePlanMsg').innerText = 'Âà†Èô§ÊàêÂäüÔºÅ';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('deletePlanMsg').innerText = result.error || 'Âà†Èô§Â§±Ë¥•';
            }
        } catch(err) {
            document.getElementById('deletePlanMsg').innerText = 'ÁΩëÁªúÈîôËØØ';
        }
    };
    // ÁÇπÂáªÂºπÁ™óÂ§ñÂÖ≥Èó≠
    ['deletePlanModal'].forEach(id=>{
        document.getElementById(id).onclick = function(e) {
            if(e.target === this) this.style.display = 'none';
        };
    });
    // Ê∑ªÂä†ÂñÇÈ£üËÆ°ÂàíÂºπÁ™óÊéßÂà∂
    function showPlanModal() {
        document.getElementById('addPlanModal').style.display = 'flex';
        document.getElementById('addPlanMsg').innerText = '';
        document.getElementById('addPlanForm').reset();
        // ËÆæÁΩÆÈªòËÆ§ÂÄºÔºöÂΩìÂâçÊó∂Èó¥ÔºåÂàÜÈáè50ÔºåÊòüÊúü
        const now = new Date();
        document.querySelector('#addPlanForm [name="hour"]').value = now.getHours();
        document.querySelector('#addPlanForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#addPlanForm [name="feeding_amount"]').value = 50;
        // JS: getDay() 0=Âë®Êó•, 1=Âë®‰∏Ä... ÈúÄËΩ¨‰∏∫1-7
        let jsDay = now.getDay();
        let planDay = jsDay === 0 ? 7 : jsDay;
        document.querySelector('#addPlanForm [name="day_of_week"]').value = planDay;
    }
    function hideAddPlanModal() {
        document.getElementById('addPlanModal').style.display = 'none';
    }
    document.getElementById('addPlanForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            device_id: "{{ device.device_id }}",
            day_of_week: form.day_of_week.value,
            hour: form.hour.value,
            minute: form.minute.value,
            feeding_amount: form.feeding_amount.value
        };
        document.getElementById('addPlanMsg').innerText = 'Êèê‰∫§‰∏≠...';
        try {
            const res = await fetch('/add_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('addPlanMsg').innerText = 'Ê∑ªÂä†ÊàêÂäüÔºÅ';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('addPlanMsg').innerText = result.error || 'Ê∑ªÂä†Â§±Ë¥•';
            }
        } catch(err) {
            document.getElementById('addPlanMsg').innerText = 'ÁΩëÁªúÈîôËØØ';
        }
    };
    document.getElementById('addPlanModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // ÊâãÂä®ÂñÇÈ£üÂºπÁ™óÊéßÂà∂
    function showManualFeedModal() {
        document.getElementById('manualFeedModal').style.display = 'flex';
        document.getElementById('manualFeedPopupMsg').innerText = '';
        document.getElementById('manualFeedPopupForm').reset();
        // ËÆæÁΩÆÈªòËÆ§ÂÄºÔºöÂΩìÂâçÊó∂Èó¥ÔºåÂàÜÈáè50
        const now = new Date();
        document.querySelector('#manualFeedPopupForm [name="hour"]').value = now.getHours();
        document.querySelector('#manualFeedPopupForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#manualFeedPopupForm [name="feeding_amount"]').value = 50;
    }
    function hideManualFeedModal() {
        document.getElementById('manualFeedModal').style.display = 'none';
    }
    document.getElementById('manualFeedPopupForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            device_id: "{{ device.device_id }}",
            hour: form.hour.value,
            minute: form.minute.value,
            feeding_amount: form.feeding_amount.value
        };
        document.getElementById('manualFeedPopupMsg').innerText = 'Êèê‰∫§‰∏≠...';
        try {
            const res = await fetch('/manual_feeding', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('manualFeedPopupMsg').innerText = 'ÂñÇÈ£üÊàêÂäüÔºÅ';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('manualFeedPopupMsg').innerText = result.error || 'ÂñÇÈ£üÂ§±Ë¥•';
            }
        } catch(err) {
            document.getElementById('manualFeedPopupMsg').innerText = 'ÁΩëÁªúÈîôËØØ';
        }
    };
    document.getElementById('manualFeedModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // ÂñÇÈ£üËÆ°ÂàíÊòüÊúüÁ≠õÈÄâ
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const week = btn.getAttribute('data-week');
            document.querySelectorAll('.plan-row').forEach(row => {
                if (week === '0' || row.getAttribute('data-week') === week) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    });
    // ÂêàÂπ∂ÂñÇÈ£üËÆ°Âàí
    {% set merged_plans = {} %}
    {% for plan in feeding_plans %}
        {% set key = plan.day_of_week ~ '-' ~ plan.hour ~ '-' ~ plan.minute %}
        {% if key in merged_plans %}
            {% set _ = merged_plans.__setitem__(key, merged_plans[key] + plan.feeding_amount) %}
        {% else %}
            {% set _ = merged_plans.__setitem__(key, plan.feeding_amount) %}
        {% endif %}
    {% endfor %}
    // ÂêàÂπ∂ÊâãÂä®ÂñÇÈ£ü
    {% set merged_manuals = {} %}
    {% for m in recent_manual_feedings %}
        {% set key = m.hour ~ '-' ~ m.minute ~ '-' ~ (m.is_executed and '1' or '0') %}
        {% if key in merged_manuals %}
            {% set _ = merged_manuals.__setitem__(key, merged_manuals[key] + m.feeding_amount) %}
        {% else %}
            {% set _ = merged_manuals.__setitem__(key, m.feeding_amount) %}
        {% endif %}
    {% endfor %}
    </script>
</body>
</html>
