<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å® ç‰©å–‚é£Ÿå™¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f9fb;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .navbar {
            background: #2563eb;
            color: #fff;
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
        }
        .navbar .logo {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .navbar .logo::before {
            content: 'ğŸ’™';
            font-size: 22px;
            margin-right: 8px;
        }
        .navbar .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .navbar .device-id {
            font-size: 15px;
            opacity: 0.92;
        }
        .navbar .logout {
            color: #fff;
            text-decoration: none;
            font-size: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            opacity: 0.85;
        }
        .navbar .logout:hover {
            text-decoration: underline;
            opacity: 1;
        }
        .main-container {
            max-width: 1200px;
            margin: 32px auto 0 auto;
            padding: 0 16px;
        }
        .status-cards {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 220px;
            min-width: 200px;
            background: linear-gradient(120deg, #4ade80 0%, #22d3ee 100%);
            color: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(34,211,238,0.08);
            padding: 24px 18px 18px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }
        .status-card.status-online { background: linear-gradient(120deg, #34d399 0%, #38bdf8 100%); }
        .status-card.status-weight { background: linear-gradient(120deg, #6366f1 0%, #818cf8 100%); }
        .status-card.status-plan { background: linear-gradient(120deg, #fbbf24 0%, #f59e42 100%); }
        .status-card.status-heartbeat { background: linear-gradient(120deg, #38bdf8 0%, #818cf8 100%); }
        .status-card.status-chart { background: linear-gradient(120deg, #60a5fa 0%, #818cf8 100%); }
        .status-card .card-title {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-card .card-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .status-card .card-desc {
            font-size: 14px;
            opacity: 0.92;
        }
        .status-card .card-icon {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 28px;
            opacity: 0.18;
        }
        .actions-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
            align-items: center;
        }
        .actions-bar button, .actions-bar .export-btn {
            padding: 8px 22px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .actions-bar .export-btn {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e42 100%);
            color: #fff;
        }
        .actions-bar button:hover, .actions-bar .export-btn:hover {
            filter: brightness(1.08);
        }
        .card-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(60, 120, 200, 0.06);
            margin-bottom: 22px;
            padding: 18px 22px 18px 22px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { font-size: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e3e3e3;
            padding: 10px 6px;
            text-align: center;
        }
        th {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        .msg {
            text-align: center;
            color: #388e3c;
            font-size: 16px;
            margin: 8px 0 0 0;
        }
        .error {
            color: #e53935;
        }
        @media (max-width: 900px) {
            .status-cards { flex-direction: column; gap: 14px; }
            .main-container { padding: 0 2vw; }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.35); /* åŠé€æ˜é®ç½© */
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 90vw;
            position: relative;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 16px;
            animation: modalPopIn 0.18s cubic-bezier(.4,1.4,.6,1) 1;
        }
        @keyframes modalPopIn {
            0% { transform: scale(0.92) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-actions {
            display: flex;
            gap: 18px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .modal-content h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #2563eb;
            font-weight: 600;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
            color: #333;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 15px;
            margin-top: 4px;
            margin-bottom: 10px;
        }
        .modal-content button {
            padding: 7px 22px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #6366f1 100%);
            transition: background 0.2s;
        }
        .modal-content button[type="button"] {
            background: #e3e3e3;
            color: #333;
        }
        .modal-content button[type="button"]:hover {
            background: #c7c7c7;
        }
        .modal-content button[type="submit"]:hover {
            filter: brightness(1.08);
        }
        .modal .msg {
            margin-top: 8px;
            text-align: left;
        }
        @media (max-width: 600px) {
            .modal-content { min-width: 90vw; padding: 18px 8vw 18px 8vw; }
        }
        .week-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .week-btn {
            padding: 5px 16px;
            border: none;
            border-radius: 5px;
            background: #e3e8ef;
            color: #2563eb;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .week-btn.active, .week-btn:hover {
            background: #2563eb;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">å® ç‰©å–‚é£Ÿå™¨</div>
        <div class="nav-right">
            <span class="device-id">ğŸ“‹ {{ device.device_id }}</span>
            <a href="/logout" class="logout">é€€å‡º</a>
        </div>
    </div>
    <div class="main-container">
        <div class="status-cards">
            <div class="status-card status-online">
                <div class="card-title">è®¾å¤‡çŠ¶æ€</div>
                <div class="card-value">{{ 'åœ¨çº¿' if device.is_online else 'ç¦»çº¿' }}</div>
                <div class="card-icon">ğŸ“¶</div>
            </div>
            <div class="status-card status-weight">
                <div class="card-title">ç²®æ¡¶é‡é‡</div>
                <div class="card-value">{{ device.grain_weight }}g</div>
                <div class="card-desc">æ›´æ–°æ—¶é—´: {{ last_grain_update_local.strftime('%H:%M:%S') if last_grain_update_local else '-' }}</div>
                <div style="position:absolute;top:18px;right:18px;display:flex;flex-direction:column;align-items:center;">
                    {% set percent = (device.grain_weight / 2000.0) if device.grain_weight < 2000 else 1.0 %}
                    <svg width="80" height="120" viewBox="0 0 80 120">
                        <defs>
                            <clipPath id="siloFillClip">
                                <rect x="20" y="22" width="40" height="60" rx="14"/>
                            </clipPath>
                        </defs>
                        <!-- ç²®ä»“å¤–è½®å»“ -->
                        <ellipse cx="40" cy="22" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <rect x="20" y="22" width="40" height="60" rx="14" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="82" rx="20" ry="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <!-- ç²®é£Ÿå¡«å…… -->
                        {% set fill_h = 60 * percent %}
                        <rect x="20" y="{{ 22+60-fill_h }}" width="40" height="{{ fill_h }}" fill="#7c4a03" clip-path="url(#siloFillClip)"/>
                        <!-- é«˜å…‰ -->
                        <ellipse cx="32" cy="52" rx="5" ry="22" fill="#fff" fill-opacity="0.10"/>
                        <!-- ç›–å­ -->
                        <ellipse cx="40" cy="14" rx="22" ry="6" fill="#e0e0e0"/>
                        <ellipse cx="40" cy="14" rx="16" ry="4" fill="#fff" fill-opacity="0.7"/>
                        <!-- å‡ºç²®å£ -->
                        <rect x="34" y="82" width="12" height="10" rx="4" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <ellipse cx="40" cy="92" rx="6" ry="3" fill="#e0e0e0" stroke="#bbb" stroke-width="1.5"/>
                        <!-- ç¢— -->
                        <rect x="16" y="92" width="48" height="20" rx="10" fill="#f5f5f5" stroke="#bbb" stroke-width="2"/>
                        <ellipse cx="40" cy="112" rx="24" ry="6" fill="#e0e0e0"/>
                        <!-- ç¢—å†…ç²®é£Ÿ -->
                        <ellipse cx="40" cy="104" rx="16" ry="5" fill="#7c4a03" fill-opacity="0.7"/>
                        <ellipse cx="40" cy="108" rx="12" ry="3" fill="#7c4a03" fill-opacity="0.5"/>
                    </svg>
                </div>
                <div style="width:100%;text-align:center;font-size:14px;font-weight:bold;color:#444;margin-top:8px;letter-spacing:1px;">æ€»å®¹é‡2000g</div>
            </div>
            <div class="status-card status-plan" style="position:relative;">
                <div class="card-title">å–‚é£Ÿè®¡åˆ’</div>
                <div class="card-value">{{ feeding_plans|length }}ä¸ª</div>
                <div class="card-desc">æ´»è·ƒè®¡åˆ’æ•°é‡</div>
                <div class="card-icon">âœ…</div>
            </div>
            <div class="status-card status-chart" style="background:linear-gradient(120deg,#60a5fa 0%,#818cf8 100%);color:#fff;">
                <div class="card-title">å–‚é£Ÿè®°å½•å›¾è¡¨</div>
                <div class="card-value" style="margin-bottom:12px;">å¯è§†åŒ–åˆ†æ</div>
                <button onclick="window.location.href='/feeding_chart'" style="padding:8px 18px;font-size:15px;border-radius:6px;background:#fff;color:#2563eb;border:none;cursor:pointer;font-weight:600;box-shadow:0 2px 8px #0002;">æŸ¥çœ‹å›¾è¡¨</button>
                <div class="card-desc" style="margin-top:10px;font-size:13px;opacity:0.92;">ç‚¹å‡»è¿›å…¥æŸ¥çœ‹24å°æ—¶å–‚é£Ÿé‡ç»Ÿè®¡</div>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="showPlanModal()" id="addPlanBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>â• æ·»åŠ å–‚é£Ÿè®¡åˆ’</button>
            <button onclick="showManualFeedModal()" id="manualFeedBtn" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %}>ğŸ¤² æ‰‹åŠ¨å–‚é£Ÿ</button>
            <button onclick="location.reload()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <a class="export-btn" href="/export_feeding_records/{{ device.device_id }}">â¬‡ï¸ å¯¼å‡ºæ•°æ®</a>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ“…</span>å–‚é£Ÿè®¡åˆ’</div>
            <table>
                <tr><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th><th>æ“ä½œ</th></tr>
                {% for key, total in merged_plans.items() %}
                {% set parts = key.split('-') %}
                <tr>
                    <td>{{ parts[0] }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ '%02d'|format(parts[2]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>
                        <button onclick="deleteMergedPlan('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">åˆ é™¤</button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5">æš‚æ— å–‚é£Ÿè®¡åˆ’</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ¤²</span>æ‰‹åŠ¨å–‚é£Ÿ</div>
            <table>
                <tr><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>æ€»åˆ†é‡ (g)</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                {% for key, total in merged_manuals.items() %}
                {% set parts = key.split('-') %}
                {% if parts[2] == '0' %} {# åªæ˜¾ç¤ºå¾…æ‰§è¡Œ #}
                <tr>
                    <td>{{ '%02d'|format(parts[0]|int) }}</td>
                    <td>{{ '%02d'|format(parts[1]|int) }}</td>
                    <td>{{ total }}</td>
                    <td>å¾…æ‰§è¡Œ</td>
                    <td>
                        <button onclick="deleteMergedManual('{{ key }}')" {% if not device.is_online %}disabled style="opacity:0.5;cursor:not-allowed;"{% endif %} style="color:#e53935;">åˆ é™¤</button>
                    </td>
                </tr>
                {% endif %}
                {% else %}
                <tr><td colspan="5">æš‚æ— æ‰‹åŠ¨å–‚é£Ÿè®°å½•</td></tr>
                {% endfor %}
            </table>
        </div>
        <div class="card-section">
            <div class="section-title"><span class="icon">ğŸ•’</span>æœ€è¿‘å–‚é£Ÿè®°å½•</div>
            <table>
                <tr><th>ç±»å‹</th><th>æ˜ŸæœŸ</th><th>å°æ—¶</th><th>åˆ†é’Ÿ</th><th>åˆ†é‡ (g)</th><th>å®é™… (g)</th><th>çŠ¶æ€</th><th>æ—¶é—´</th></tr>
                {% for record in recent_records %}
                <tr>
                    <td>è®¡åˆ’</td>
                    <td>{{ record.day_of_week }}</td>
                    <td>{{ '%02d'|format(record.hour) }}</td>
                    <td>{{ '%02d'|format(record.minute) }}</td>
                    <td>{{ record.feeding_amount }}</td>
                    <td>{{ record.actual_amount }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
                {% for m in recent_manual_feedings %}
                {% if m.is_executed %}
                <tr>
                    <td>æ‰‹åŠ¨</td>
                    <td>-</td>
                    <td>{{ '%02d'|format(m.hour) }}</td>
                    <td>{{ '%02d'|format(m.minute) }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>{{ m.feeding_amount }}</td>
                    <td>å·²æ‰§è¡Œ</td>
                    <td>{{ m.executed_at.strftime('%Y-%m-%d %H:%M:%S') if m.executed_at else '-' }}</td>
                </tr>
                {% endif %}
                {% else %}
                <tr><td colspan="8">æš‚æ— å–‚é£Ÿè®°å½•</td></tr>
                {% endfor %}
            </table>
        </div>
        <!-- æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª— -->
        <div class="modal" id="addPlanModal">
            <div class="modal-content">
                <h3>æ·»åŠ å–‚é£Ÿè®¡åˆ’</h3>
                <form id="addPlanForm" onsubmit="return false;">
                    <label>æ˜ŸæœŸ
                        <select name="day_of_week" required>
                            <option value="1">æ˜ŸæœŸä¸€</option>
                            <option value="2">æ˜ŸæœŸäºŒ</option>
                            <option value="3">æ˜ŸæœŸä¸‰</option>
                            <option value="4">æ˜ŸæœŸå››</option>
                            <option value="5">æ˜ŸæœŸäº”</option>
                            <option value="6">æ˜ŸæœŸå…­</option>
                            <option value="7">æ˜ŸæœŸæ—¥</option>
                        </select>
                    </label>
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideAddPlanModal()">å–æ¶ˆ</button>
                        <button type="submit" class="add-plan-btn">æ·»åŠ </button>
                    </div>
                </form>
                <div id="addPlanMsg" class="msg"></div>
            </div>
        </div>
        <!-- æ‰‹åŠ¨å–‚é£Ÿå¼¹çª— -->
        <div class="modal" id="manualFeedModal">
            <div class="modal-content">
                <h3>æ‰‹åŠ¨å–‚é£Ÿ</h3>
                <form id="manualFeedPopupForm" onsubmit="return false;">
                    <label>å°æ—¶
                        <input type="number" name="hour" min="0" max="23" required>
                    </label>
                    <label>åˆ†é’Ÿ
                        <input type="number" name="minute" min="0" max="59" required>
                    </label>
                    <label>åˆ†é‡ (g)
                        <input type="number" name="feeding_amount" min="1" max="500" required>
                    </label>
                    <div class="modal-actions">
                        <button type="button" onclick="hideManualFeedModal()">å–æ¶ˆ</button>
                        <button type="submit" class="feed-btn">ç«‹å³å–‚é£Ÿ</button>
                    </div>
                </form>
                <div id="manualFeedPopupMsg" class="msg"></div>
            </div>
        </div>
        <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
        <div class="modal" id="deletePlanModal">
            <div class="modal-content">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <div>ç¡®å®šè¦åˆ é™¤è¯¥å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ</div>
                <div class="modal-actions">
                    <button type="button" onclick="hideDeletePlanModal()">å–æ¶ˆ</button>
                    <button type="button" id="deletePlanBtn" style="background:#e53935; color:#fff;">åˆ é™¤</button>
                </div>
                <div id="deletePlanMsg" class="msg"></div>
            </div>
        </div>
    </div>
    <script>
    // åˆ é™¤å¼¹çª—æ§åˆ¶
    let deletePlanId = null;
    function confirmDeletePlan(id) {
        if (!id) return;
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ')) return;
        fetch('/delete_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({id: id})
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('åˆ é™¤æˆåŠŸï¼');
                location.reload();
            } else {
                alert(result.error || 'åˆ é™¤å¤±è´¥');
            }
        }).catch(()=>alert('ç½‘ç»œé”™è¯¯'));
    }
    function hideDeletePlanModal() {
        document.getElementById('deletePlanModal').style.display = 'none';
    }
    document.getElementById('deletePlanBtn').onclick = async function() {
        if (!deletePlanId) return;
        document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
        try {
            const res = await fetch('/delete_feeding_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id: deletePlanId})
            });
            const result = await res.json();
            if (res.ok) {
                document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                setTimeout(()=>{ location.reload(); }, 800);
            } else {
                document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
            }
        } catch(err) {
            document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        }
    };
    // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
    ['deletePlanModal'].forEach(id=>{
        document.getElementById(id).onclick = function(e) {
            if(e.target === this) this.style.display = 'none';
        };
    });
    // æ·»åŠ å–‚é£Ÿè®¡åˆ’å¼¹çª—æ§åˆ¶
    function showPlanModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        document.getElementById('addPlanModal').style.display = 'flex';
        document.getElementById('addPlanMsg').innerText = '';
        document.getElementById('addPlanForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50ï¼Œæ˜ŸæœŸ
        const now = new Date();
        document.querySelector('#addPlanForm [name="hour"]').value = now.getHours();
        document.querySelector('#addPlanForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#addPlanForm [name="feeding_amount"]').value = 50;
        // JS: getDay() 0=å‘¨æ—¥, 1=å‘¨ä¸€... éœ€è½¬ä¸º1-7
        let jsDay = now.getDay();
        let planDay = jsDay === 0 ? 7 : jsDay;
        document.querySelector('#addPlanForm [name="day_of_week"]').value = planDay;
    }
    function hideAddPlanModal() {
        document.getElementById('addPlanModal').style.display = 'none';
    }
    // ä¿®æ”¹æ·»åŠ å–‚é£Ÿè®¡åˆ’åç­‰å¾…è®¾å¤‡ç¡®è®¤é€»è¾‘ï¼Œæ”¯æŒé‡è¯•
    function waitForPlanConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5; // æ¯æ¬¡æœ€å¤šç­‰5æ¬¡ï¼ˆ5ç§’ï¼‰
        const maxSend = 3; // æœ€å¤šé‡å‘3æ¬¡
        const msgDiv = document.getElementById('addPlanMsg');
        msgDiv.innerText = `ç­‰å¾…è®¾å¤‡ç¡®è®¤...ï¼ˆç¬¬${tryCount}æ¬¡ï¼‰`;
        function poll() {
            fetch(`/get_feeding_plans?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    if (resp.feeding_plans && resp.feeding_plans.some(p =>
                        p.day_of_week == data.day_of_week &&
                        p.hour == data.hour &&
                        p.minute == data.minute &&
                        p.feeding_amount == data.feeding_amount
                    )) {
                        msgDiv.innerText = 'æ·»åŠ æˆåŠŸï¼';
                        setTimeout(()=>{ location.reload(); }, 800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        // è¶…æ—¶é‡å‘
                        msgDiv.innerText = `ç¬¬${tryCount+1}æ¬¡é‡å‘...`;
                        sendPlanWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = 'ä¸‹å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = 'ç½‘ç»œé”™è¯¯';
                });
        }
        poll();
    }
    function sendPlanWithRetry(data, tryCount) {
        fetch('/add_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                waitForPlanConfirmWithRetry(data, tryCount);
            } else {
                document.getElementById('addPlanMsg').innerText = result.error || 'æ·»åŠ å¤±è´¥';
            }
        }).catch(()=>{
            document.getElementById('addPlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        });
    }
    if (document.getElementById('addPlanForm')) {
        document.getElementById('addPlanForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                day_of_week: form.day_of_week.value,
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('addPlanMsg').innerText = 'æäº¤ä¸­...';
            sendPlanWithRetry(data, 1);
        };
    }
    document.getElementById('addPlanModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // æ‰‹åŠ¨å–‚é£Ÿå¼¹çª—æ§åˆ¶
    function showManualFeedModal() {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        document.getElementById('manualFeedModal').style.display = 'flex';
        document.getElementById('manualFeedPopupMsg').innerText = '';
        document.getElementById('manualFeedPopupForm').reset();
        // è®¾ç½®é»˜è®¤å€¼ï¼šå½“å‰æ—¶é—´ï¼Œåˆ†é‡50
        const now = new Date();
        document.querySelector('#manualFeedPopupForm [name="hour"]').value = now.getHours();
        document.querySelector('#manualFeedPopupForm [name="minute"]').value = now.getMinutes();
        document.querySelector('#manualFeedPopupForm [name="feeding_amount"]').value = 50;
    }
    function hideManualFeedModal() {
        document.getElementById('manualFeedModal').style.display = 'none';
    }
    // æ‰‹åŠ¨å–‚é£Ÿé‡è¯•æœºåˆ¶
    function waitForManualConfirmWithRetry(data, tryCount = 1) {
        let retry = 0;
        const maxRetry = 5;
        const maxSend = 3;
        const msgDiv = document.getElementById('manualFeedPopupMsg');
        msgDiv.innerText = `ç­‰å¾…è®¾å¤‡ç¡®è®¤...ï¼ˆç¬¬${tryCount}æ¬¡ï¼‰`;
        function poll() {
            fetch(`/api/manual_feedings?device_id=${data.device_id}`)
                .then(res => res.json())
                .then(resp => {
                    if (resp.manual_feedings && resp.manual_feedings.some(m =>
                        m.hour == data.hour &&
                        m.minute == data.minute &&
                        m.feeding_amount == data.feeding_amount &&
                        m.is_executed
                    )) {
                        msgDiv.innerText = 'å–‚é£ŸæˆåŠŸï¼';
                        setTimeout(()=>{ location.reload(); }, 800);
                    } else if (++retry < maxRetry) {
                        setTimeout(poll, 1000);
                    } else if (tryCount < maxSend) {
                        msgDiv.innerText = `ç¬¬${tryCount+1}æ¬¡é‡å‘...`;
                        sendManualWithRetry(data, tryCount+1);
                    } else {
                        msgDiv.innerText = 'ä¸‹å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    }
                })
                .catch(()=>{
                    msgDiv.innerText = 'ç½‘ç»œé”™è¯¯';
                });
        }
        poll();
    }
    function sendManualWithRetry(data, tryCount) {
        fetch('/manual_feeding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                waitForManualConfirmWithRetry(data, tryCount);
            } else {
                document.getElementById('manualFeedPopupMsg').innerText = result.error || 'å–‚é£Ÿå¤±è´¥';
            }
        }).catch(()=>{
            document.getElementById('manualFeedPopupMsg').innerText = 'ç½‘ç»œé”™è¯¯';
        });
    }
    if (document.getElementById('manualFeedPopupForm')) {
        document.getElementById('manualFeedPopupForm').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                device_id: "{{ device.device_id }}",
                hour: form.hour.value,
                minute: form.minute.value,
                feeding_amount: form.feeding_amount.value
            };
            document.getElementById('manualFeedPopupMsg').innerText = 'æäº¤ä¸­...';
            sendManualWithRetry(data, 1);
        };
    }
    document.getElementById('manualFeedModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    };
    // å–‚é£Ÿè®¡åˆ’æ˜ŸæœŸç­›é€‰
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.onclick = function() {
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const week = btn.getAttribute('data-week');
            document.querySelectorAll('.plan-row').forEach(row => {
                if (week === '0' || row.getAttribute('data-week') === week) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
    });
    // åˆå¹¶å–‚é£Ÿè®¡åˆ’
    {% set merged_plans = {} %}
    {% for plan in feeding_plans %}
        {% set key = plan.day_of_week ~ '-' ~ plan.hour ~ '-' ~ plan.minute %}
        {% if key in merged_plans %}
            {% set _ = merged_plans.__setitem__(key, merged_plans[key] + plan.feeding_amount) %}
        {% else %}
            {% set _ = merged_plans.__setitem__(key, plan.feeding_amount) %}
        {% endif %}
    {% endfor %}
    // åˆå¹¶æ‰‹åŠ¨å–‚é£Ÿ
    {% set merged_manuals = {} %}
    {% for m in recent_manual_feedings %}
        {% set key = m.hour ~ '-' ~ m.minute ~ '-' ~ (m.is_executed and '1' or '0') %}
        {% if key in merged_manuals %}
            {% set _ = merged_manuals.__setitem__(key, merged_manuals[key] + m.feeding_amount) %}
        {% else %}
            {% set _ = merged_manuals.__setitem__(key, m.feeding_amount) %}
        {% endif %}
    {% endfor %}
    // æ–°å¢ï¼šæ‰‹åŠ¨å–‚é£Ÿåˆ é™¤å¼¹çª—æ§åˆ¶
    let deleteManualId = null;
    function confirmDeleteManual(id) {
        deleteManualId = id;
        document.getElementById('deletePlanModal').style.display = 'flex';
        document.getElementById('deletePlanMsg').innerText = '';
        // ä¿®æ”¹å¼¹çª—å†…å®¹
        document.querySelector('#deletePlanModal h3').innerText = 'ç¡®è®¤åˆ é™¤';
        document.querySelector('#deletePlanModal .modal-content > div').innerText = 'ç¡®å®šè¦åˆ é™¤è¯¥æ‰‹åŠ¨å–‚é£Ÿè®°å½•å—ï¼Ÿ';
        // ä¿®æ”¹æŒ‰é’®äº‹ä»¶
        document.getElementById('deletePlanBtn').onclick = async function() {
            if (!deleteManualId) return;
            document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤ä¸­...';
            try {
                const res = await fetch('/delete_manual_feeding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({id: deleteManualId})
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('deletePlanMsg').innerText = 'åˆ é™¤æˆåŠŸï¼';
                    setTimeout(()=>{ location.reload(); }, 800);
                } else {
                    document.getElementById('deletePlanMsg').innerText = result.error || 'åˆ é™¤å¤±è´¥';
                }
            } catch(err) {
                document.getElementById('deletePlanMsg').innerText = 'ç½‘ç»œé”™è¯¯';
            }
        };
    }
    // æ–°å¢ï¼šåˆå¹¶æ‰‹åŠ¨å–‚é£Ÿåˆ é™¤
    function deleteMergedManual(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ—¶é—´ç‚¹çš„æ‰€æœ‰å¾…æ‰§è¡Œæ‰‹åŠ¨å–‚é£Ÿå—ï¼Ÿ')) return;
        fetch('/delete_manual_feeding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ merged_key: key })
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('åˆ é™¤æˆåŠŸï¼');
                location.reload();
            } else {
                alert(result.error || 'åˆ é™¤å¤±è´¥');
            }
        }).catch(()=>alert('ç½‘ç»œé”™è¯¯'));
    }
    // åªä¿ç•™åˆå¹¶è®¡åˆ’çš„æ‰¹é‡åˆ é™¤é€»è¾‘
    function deleteMergedPlan(key) {
        if ({{ 'false' if device.is_online else 'true' }}) {
            alert('è®¾å¤‡ä¸åœ¨çº¿ï¼Œæ— æ³•æ“ä½œ');
            return;
        }
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ—¶é—´ç‚¹çš„æ‰€æœ‰å–‚é£Ÿè®¡åˆ’å—ï¼Ÿ')) return;
        fetch('/delete_feeding_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ merged_key: key })
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('åˆ é™¤æˆåŠŸï¼');
                location.reload();
            } else {
                alert(result.error || 'åˆ é™¤å¤±è´¥');
            }
        }).catch(()=>alert('ç½‘ç»œé”™è¯¯'));
    }
    </script>
</body>
</html>
