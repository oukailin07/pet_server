# 宠物喂食器服务器功能总结

## 🎯 实现的功能

### 1. 设备管理 ✅
- **自动设备ID分配**: 新设备连接时自动分配ESP-001、ESP-002等格式的设备ID
- **密码管理**: 默认密码123456，使用hash加密存储
- **设备状态监控**: 实时监控设备在线/离线状态
- **心跳包处理**: 处理设备心跳包，更新设备状态和连接次数

### 2. 数据库管理 ✅
- **设备信息表**: 存储设备基本信息、状态、粮桶重量等
- **喂食计划表**: 管理定时喂食计划（星期、时间、重量）
- **手动喂食表**: 记录手动喂食指令
- **喂食记录表**: 存储喂食执行记录和结果

### 3. Web界面 ✅
- **登录系统**: 设备ID和密码验证，美观的登录界面
- **设备状态**: 显示设备在线情况、粮桶重量、心跳次数等
- **喂食计划管理**: 添加、查看、删除喂食计划
- **手动喂食**: 发送手动喂食指令
- **喂食记录**: 查看历史喂食记录
- **设备管理**: 管理员查看所有设备列表

### 4. API接口 ✅
- **设备心跳包**: `/device/heartbeat`
- **粮桶重量上传**: `/upload_grain_level`
- **添加喂食计划**: `/add_feeding_plan`
- **手动喂食**: `/manual_feeding`
- **添加喂食记录**: `/add_feeding_record`
- **设备列表**: `/api/devices`
- **喂食计划**: `/api/feeding_plans/<device_id>`
- **喂食记录**: `/api/feeding_records/<device_id>`

## 📁 文件结构

```
pet_feeder_server/
├── pet_feeder_server.py      # 主服务器文件
├── config.py                 # 配置文件
├── start_server.py           # 启动脚本
├── test_server.py            # 测试脚本
├── requirements.txt          # Python依赖
├── run.bat                   # Windows启动脚本
├── README_SERVER.md          # 详细说明文档
├── SERVER_SUMMARY.md         # 功能总结文档
├── templates/                # HTML模板
│   ├── login.html           # 登录页面
│   ├── index.html           # 主页
│   └── devices.html         # 设备管理页面
├── static/                   # 静态文件
├── logs/                     # 日志文件
└── pet_feeder.db            # SQLite数据库
```

## 🚀 快速启动

### 方法1: 使用批处理文件（Windows）
```bash
双击运行 run.bat
```

### 方法2: 使用Python脚本
```bash
python start_server.py
```

### 方法3: 直接运行
```bash
pip install -r requirements.txt
python pet_feeder_server.py
```

## 🔧 使用流程

### 1. 设备首次连接
1. ESP32设备启动并连接WiFi
2. 发送心跳包（device_id为空）
3. 服务器分配设备ID（ESP-001）和密码（123456）
4. 设备保存ID和密码到NVS

### 2. 设备正常使用
1. 设备定期发送心跳包（每5分钟）
2. 服务器更新设备状态
3. 设备上传粮桶重量
4. 设备执行喂食计划
5. 设备上报喂食记录

### 3. Web界面使用
1. 访问 http://127.0.0.1:80
2. 输入设备ID和密码登录
3. 查看设备状态和喂食记录
4. 添加或修改喂食计划
5. 发送手动喂食指令

## 🧪 测试功能

运行测试脚本验证所有功能：
```bash
python test_server.py
```

测试内容包括：
- 新设备心跳包注册
- 已注册设备心跳包
- 粮桶重量上传
- 添加喂食计划
- 手动喂食指令
- 添加喂食记录
- API端点测试
- Web界面测试

## 📊 数据库结构

### devices表
- 设备ID、密码、类型、固件版本
- 首次连接时间、最后心跳时间
- 在线状态、心跳次数
- 粮桶重量、最后更新时间

### feeding_plans表
- 设备ID、星期、时间、喂食量
- 是否激活、创建时间

### manual_feedings表
- 设备ID、时间、喂食量
- 是否执行、创建时间、执行时间

### feeding_records表
- 设备ID、星期、时间、计划重量
- 实际重量、状态、创建时间

## 🎨 Web界面特色

### 1. 响应式设计
- 支持手机、平板、电脑访问
- Bootstrap 5现代化界面
- 美观的渐变色彩搭配

### 2. 实时状态显示
- 设备在线状态卡片
- 粮桶重量实时显示
- 喂食计划数量统计
- 心跳次数监控

### 3. 交互功能
- 模态框添加喂食计划
- 实时数据刷新
- 表格排序和搜索
- 操作确认对话框

## 🔒 安全特性

1. **密码安全**: 使用Werkzeug hash函数加密存储
2. **会话管理**: Flask session管理用户登录状态
3. **输入验证**: 对所有用户输入进行验证
4. **SQL注入防护**: 使用SQLAlchemy ORM
5. **XSS防护**: Jinja2模板引擎自动转义

## 📈 性能优化

1. **数据库索引**: 为常用查询字段添加索引
2. **连接池**: 使用SQLAlchemy连接池
3. **异步处理**: 后台线程处理离线检测
4. **缓存机制**: 减少重复数据库查询

## 🔧 配置选项

通过 `config.py` 文件可以配置：
- 服务器地址和端口
- 数据库连接
- 安全密钥
- 心跳超时时间
- 喂食量限制
- 日志级别

## 🐛 故障排除

### 常见问题
1. **端口占用**: 修改config.py中的端口号
2. **依赖缺失**: 运行 `pip install -r requirements.txt`
3. **数据库错误**: 删除pet_feeder.db重新创建
4. **权限问题**: 确保有写入logs目录的权限

### 日志查看
- 服务器日志: `logs/pet_feeder.log`
- 控制台输出: 实时显示请求和错误信息

## 🚀 扩展功能

### 已预留扩展接口
1. **用户管理**: 多用户权限系统
2. **数据导出**: CSV/Excel格式导出
3. **通知功能**: 邮件/短信通知
4. **数据分析**: 统计图表和分析
5. **API认证**: JWT token认证
6. **负载均衡**: 多实例部署支持

## 📞 技术支持

### 文件说明
- `README_SERVER.md`: 详细使用说明
- `test_server.py`: 功能测试脚本
- `config.py`: 配置参数说明
- `pet_feeder_server.py`: 核心代码注释

### 调试方法
1. 启用DEBUG模式: 修改config.py中的DEBUG_MODE = True
2. 查看详细日志: 修改LOG_LEVEL = "DEBUG"
3. 使用测试脚本: 验证各个功能模块

## ✅ 功能验证清单

- [x] 设备自动注册和ID分配
- [x] 心跳包处理和状态更新
- [x] 粮桶重量上传和显示
- [x] 喂食计划添加和管理
- [x] 手动喂食指令发送
- [x] 喂食记录存储和查询
- [x] Web界面登录和权限控制
- [x] 设备状态实时监控
- [x] 数据库持久化存储
- [x] API接口完整实现
- [x] 错误处理和日志记录
- [x] 安全防护措施
- [x] 响应式界面设计
- [x] 测试脚本验证
- [x] 配置文件管理
- [x] 启动脚本自动化

## 🎉 总结

这个宠物喂食器服务器是一个功能完整、安全可靠的解决方案，包含了：

1. **完整的设备管理** - 自动注册、状态监控、心跳处理
2. **强大的数据库** - 4个核心表，支持复杂查询
3. **美观的Web界面** - 响应式设计，用户体验优秀
4. **丰富的API接口** - 支持所有设备操作
5. **完善的安全机制** - 密码加密、会话管理、输入验证
6. **详细的文档** - 使用说明、测试脚本、配置指南

服务器已经可以直接使用，支持多设备管理，具有良好的扩展性和维护性。 